<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½œä¸šæ’­æŠ¥ - YoBox</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“–</text></svg>">

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent: #ff6b00;
            --border: rgba(0,0,0,0.08);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #1c1c1e;
                --text-primary: #f5f5f7;
                --text-secondary: #86868b;
                --border: rgba(255,255,255,0.1);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "PingFang SC", sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å¯¼èˆªæ  */
        header {
            background: rgba(255,255,255,0.72);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        @media (prefers-color-scheme: dark) {
            header {
                background: rgba(28,28,30,0.72);
            }
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .back-link:hover {
            opacity: 0.8;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* ä¸»å†…å®¹åŒº */
        main {
            flex: 1;
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            padding: 24px 20px;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .card {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            margin-bottom: 16px;
        }

        .section-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .char-count {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        textarea {
            width: 100%;
            min-height: 160px;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 14px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: all 0.2s;
            line-height: 1.7;
            background: var(--bg-secondary);
        }

        textarea:focus {
            background: var(--bg-primary);
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(255,107,0,0.1);
        }

        textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        /* æ§åˆ¶åŒºåŸŸ */
        .control-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 14px;
            font-weight: 500;
            min-width: 60px;
        }

        select {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--bg-secondary);
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        select:focus {
            background: var(--bg-primary);
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(255,107,0,0.1);
        }

        /* è¯­é€Ÿæ»‘å— */
        .speed-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            outline: none;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255,107,0,0.3);
        }

        .speed-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(255,107,0,0.3);
        }

        .speed-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent);
            min-width: 45px;
            text-align: right;
        }

        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 16px rgba(255,107,0,0.25);
        }

        .btn-primary:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(255,107,0,0.3);
        }

        .btn-primary:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-primary);
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status-bar {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
            transition: background 0.3s;
        }

        .status-indicator.playing {
            background: #34c759;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-indicator.paused {
            background: #ff9500;
        }

        .status-text {
            flex: 1;
            font-size: 15px;
            color: var(--text-secondary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ç¤ºä¾‹æŒ‰é’® */
        .example-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .example-btn {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
            line-height: 1.6;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }

        .pill-toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .pill-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .pill-toggle span {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-secondary);
            border-radius: 999px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .pill-toggle span::before {
            content: '';
            position: absolute;
            left: 3px;
            top: 3px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
            transition: all 0.2s;
        }

        .pill-toggle input:checked + span {
            background: var(--accent);
            border-color: var(--accent);
        }

        .pill-toggle input:checked + span::before {
            transform: translateX(20px);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            main {
                padding: 16px;
            }

            .card {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        :is(button, a, textarea, select):focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <header>
        <a href="../" class="back-link">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2.5" fill="none">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            è¿”å› YoBox
        </a>
        <span class="header-title">ğŸ“– ä½œä¸šæ’­æŠ¥</span>
    </header>

    <main>
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="card">
            <div class="section-label">
                <span>è¾“å…¥ä½œä¸šå†…å®¹</span>
                <span class="char-count" id="charCount">0 å­—</span>
            </div>
            <textarea
                id="textInput"
                placeholder="è¯·ç²˜è´´è€å¸ˆå‘çš„ä½œä¸šæ–‡å­—...&#10;&#10;ä¾‹å¦‚ï¼š&#10;ä»Šå¤©è¯­æ–‡ä½œä¸šï¼š&#10;1. å¤ä¹ ç¬¬1-5è¯¾ç”Ÿå­—ï¼Œæ¯ä¸ªå­—å†™3é&#10;2. é¢„ä¹ ç¬¬6è¯¾ï¼Œæœ—è¯»è¯¾æ–‡3é&#10;3. èƒŒè¯µå¤è¯—ã€Šé™å¤œæ€ã€‹"
            ></textarea>
            <div class="example-buttons">
                <button class="example-btn" onclick="loadExample(1)">è¯­æ–‡ä½œä¸šç¤ºä¾‹</button>
                <button class="example-btn" onclick="loadExample(2)">æ•°å­¦ä½œä¸šç¤ºä¾‹</button>
                <button class="example-btn" onclick="loadExample(3)">ç»¼åˆä½œä¸šç¤ºä¾‹</button>
            </div>
        </div>

        <!-- æ§åˆ¶åŒºåŸŸ -->
        <div class="card">
            <div class="section-label">æ’­æ”¾è®¾ç½®</div>

            <div class="control-row">
                <span class="control-label">è¯­é€Ÿ</span>
                <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
                <span class="speed-value" id="speedValue">1.0x</span>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="playBtn" onclick="togglePlay()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    å¼€å§‹æ’­æ”¾
                </button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopSpeaking()" disabled>
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12"/>
                    </svg>
                    åœæ­¢
                </button>
            </div>
        </div>

        <!-- é«˜çº§æ’­æŠ¥ -->
        <div class="card">
            <div class="section-label">
                <div class="toggle-row">
                    <span>é«˜çº§æ’­æŠ¥ï¼ˆè‡ªå®šä¹‰æ¥å£ï¼‰</span>
                    <label class="pill-toggle">
                        <input type="checkbox" id="enableCustomApi">
                        <span></span>
                    </label>
                </div>
            </div>

            <div id="customApiPanel" style="display:none; margin-top: 12px; gap: 12px; grid-template-columns: 1fr;">
                <div class="control-row" style="align-items: flex-start;">
                    <span class="control-label" style="min-width:80px;">æ¥å£åœ°å€</span>
                    <input id="customApiUrl" placeholder="ä¾‹å¦‚ï¼šhttps://your-proxy/api/tts">
                </div>
                <div class="control-row" style="align-items: flex-start;">
                    <span class="control-label" style="min-width:80px;">æ¥å£å¯†é’¥</span>
                    <input id="customApiKey" type="password" placeholder="Bearer Tokenï¼Œå°†ä»…å­˜æœ¬åœ°">
                </div>
                <div class="control-row" style="align-items: flex-start;">
                    <span class="control-label" style="min-width:80px;">æ¨¡å‹/å£°çº¿</span>
                    <input id="customModel" placeholder="å¦‚ deepseek-tts / spark-lite / chattts-1">
                </div>
                <div class="control-row">
                    <span class="control-label" style="min-width:80px;">å“åº”ç±»å‹</span>
                    <select id="customResponseMode">
                        <option value="audio">è¿”å›éŸ³é¢‘ï¼ˆaudioUrl æˆ– audioBase64ï¼‰</option>
                        <option value="text">è¿”å›æ–‡æœ¬ï¼ˆå†ç”¨æœ¬åœ°è¯­éŸ³æ’­æŠ¥ï¼‰</option>
                    </select>
                </div>
                <div class="hint">
                    æ¥å£éœ€æ¥å— POST JSONï¼š{ text, model, speed }ï¼Œå¯é€‰ Authorization: Bearer &lt;token&gt;ã€‚<br>
                    éŸ³é¢‘æ¨¡å¼ï¼šè¿”å› audioUrl / audioBase64(+mimeType)ã€‚æ–‡æœ¬æ¨¡å¼ï¼šè¿”å› text / content / output å­—æ®µã€‚
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span class="status-text" id="statusText">å‡†å¤‡å°±ç»ª</span>
        </div>
    </main>

    <script>
        // è·å–å…ƒç´ 
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const enableCustomApi = document.getElementById('enableCustomApi');
        const customApiPanel = document.getElementById('customApiPanel');
        const customApiUrl = document.getElementById('customApiUrl');
        const customApiKey = document.getElementById('customApiKey');
        const customModel = document.getElementById('customModel');
        const customResponseMode = document.getElementById('customResponseMode');

        // è¯­éŸ³åˆæˆ
        let synth = window.speechSynthesis;
        let utterance = null;
        let isPaused = false;
        let isPlaying = false;
        let customAudio = null;

        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        textInput.addEventListener('input', () => {
            charCount.textContent = `${textInput.value.length} å­—`;
        });

        // è¯­é€Ÿæ»‘å—
        speedSlider.addEventListener('input', () => {
            speedValue.textContent = `${parseFloat(speedSlider.value).toFixed(1)}x`;
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢åé‡æ–°å¼€å§‹
            if (isPlaying && !isPaused) {
                stopSpeaking();
            }
        });

        // ç¤ºä¾‹æ–‡æœ¬
        const examples = {
            1: `ä»Šå¤©è¯­æ–‡ä½œä¸šï¼š
1. å¤ä¹ ç¬¬1-5è¯¾ç”Ÿå­—ï¼Œæ¯ä¸ªå­—å†™3é
2. é¢„ä¹ ç¬¬6è¯¾ï¼Œæœ—è¯»è¯¾æ–‡3éç»™å®¶é•¿å¬
3. èƒŒè¯µå¤è¯—ã€Šé™å¤œæ€ã€‹ï¼Œå¹¶é»˜å†™
4. å®Œæˆç»ƒä¹ å†Œç¬¬8é¡µ`,

            2: `ä»Šå¤©æ•°å­¦ä½œä¸šï¼š
1. å®Œæˆå£ç®—ç»ƒä¹ é¢˜ï¼Œç¬¬15é¡µåˆ°ç¬¬18é¡µ
2. å¤ä¹ 20ä»¥å†…çš„åŠ å‡æ³•ï¼Œå‡†å¤‡æ˜å¤©æµ‹éªŒ
3. å®Œæˆåº”ç”¨é¢˜3é“ï¼Œå†™åœ¨ä½œä¸šæœ¬ä¸Š
4. é¢„ä¹ ä¸‹ä¸€è¯¾ã€Šè®¤è¯†å›¾å½¢ã€‹`,

            3: `ä»Šæ—¥ä½œä¸šå®‰æ’ï¼š

è¯­æ–‡ï¼š
1. æœ—è¯»è¯¾æ–‡ã€Šç§‹å¤©ã€‹3é
2. ç”Ÿå­—æœ¬æŠ„å†™ç”Ÿå­—ï¼Œæ¯ä¸ªå­—å†™5é
3. å®Œæˆé…å¥—ç»ƒä¹ å†Œç¬¬10é¡µ

æ•°å­¦ï¼š
1. å£ç®—é¢˜å¡ç¬¬12é¡µ
2. å¤ä¹ å‡‘åæ³•

å…¶ä»–ï¼š
1. è·³ç»³100ä¸ª
2. é˜…è¯»20åˆ†é’Ÿè¯¾å¤–ä¹¦`
        };

        function loadExample(num) {
            textInput.value = examples[num];
            charCount.textContent = `${examples[num].length} å­—`;
            updateStatus('å·²åŠ è½½ç¤ºä¾‹æ–‡æœ¬', '');
        }

        function updateStatus(text, state) {
            statusText.textContent = text;
            statusIndicator.className = 'status-indicator';
            if (state) {
                statusIndicator.classList.add(state);
            }
        }

        function updatePlayButton() {
            const useCustom = enableCustomApi?.checked;
            if (useCustom && isPlaying) {
                playBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12"/>
                    </svg>
                    åœæ­¢é«˜çº§æ’­æŠ¥
                `;
                return;
            }
            if (isPaused) {
                playBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    ç»§ç»­æ’­æ”¾
                `;
            } else if (isPlaying) {
                playBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <rect x="6" y="4" width="4" height="16"/>
                        <rect x="14" y="4" width="4" height="16"/>
                    </svg>
                    æš‚åœ
                `;
            } else {
                playBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    å¼€å§‹æ’­æ”¾
                `;
            }
        }

        async function togglePlay() {
            if (enableCustomApi?.checked) {
                if (isPlaying) {
                    stopSpeaking();
                } else {
                    await playViaCustomApi();
                }
                return;
            }
            if (isPlaying && isPaused) {
                // æ¢å¤æ’­æ”¾
                synth.resume();
                isPaused = false;
                updatePlayButton();
                updateStatus('æ­£åœ¨æ’­æ”¾...', 'playing');
            } else if (isPlaying) {
                // æš‚åœæ’­æ”¾
                synth.pause();
                isPaused = true;
                updatePlayButton();
                updateStatus('å·²æš‚åœ', 'paused');
            } else {
                // å¼€å§‹æ’­æ”¾
                speak();
            }
        }

        async function playViaCustomApi() {
            const text = textInput.value.trim();
            if (!text) {
                updateStatus('è¯·å…ˆè¾“å…¥è¦æ’­æŠ¥çš„å†…å®¹', '');
                return;
            }
            const apiUrl = customApiUrl.value.trim();
            if (!apiUrl) {
                updateStatus('è¯·å¡«å†™è‡ªå®šä¹‰æ¥å£åœ°å€', '');
                return;
            }
            stopSpeaking();
            updateStatus('å‘è‡ªå®šä¹‰æ¥å£è¯·æ±‚ä¸­â€¦', '');
            const payload = {
                text,
                model: customModel.value.trim() || undefined,
                speed: parseFloat(speedSlider.value)
            };
            const headers = { 'Content-Type': 'application/json' };
            if (customApiKey.value.trim()) {
                headers['Authorization'] = `Bearer ${customApiKey.value.trim()}`;
            }

            let data = null;
            try {
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                data = await res.json();
            } catch (err) {
                console.error('custom api error', err);
                updateStatus(`è°ƒç”¨æ¥å£å¤±è´¥ï¼š${err.message}`, '');
                return;
            }

            if (customResponseMode.value === 'audio') {
                const audioUrl = data?.audioUrl || data?.url;
                const audioBase64 = data?.audioBase64 || data?.base64;
                const mime = data?.mimeType || 'audio/mpeg';
                let src = audioUrl;
                if (!src && audioBase64) src = `data:${mime};base64,${audioBase64}`;
                if (!src) {
                    updateStatus('æ¥å£æœªè¿”å› audioUrl/audioBase64', '');
                    return;
                }
                try {
                    customAudio = new Audio(src);
                    customAudio.onplay = () => {
                        isPlaying = true;
                        isPaused = false;
                        stopBtn.disabled = false;
                        updatePlayButton();
                        updateStatus('æ­£åœ¨æ’­æ”¾...', 'playing');
                    };
                    customAudio.onended = () => {
                        isPlaying = false;
                        isPaused = false;
                        stopBtn.disabled = true;
                        updatePlayButton();
                        updateStatus('æ’­æ”¾å®Œæˆ', '');
                        customAudio = null;
                    };
                    customAudio.onerror = () => {
                        isPlaying = false;
                        isPaused = false;
                        stopBtn.disabled = true;
                        updatePlayButton();
                        updateStatus('æ’­æ”¾å‡ºé”™ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘', '');
                        customAudio = null;
                    };
                    await customAudio.play();
                } catch (err) {
                    console.error('audio play error', err);
                    updateStatus(`éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼š${err.message}`, '');
                }
            } else {
                const newText = data?.text || data?.content || data?.output;
                if (!newText) {
                    updateStatus('æ¥å£æœªè¿”å›æ–‡æœ¬å­—æ®µ', '');
                    return;
                }
                textInput.value = newText;
                charCount.textContent = `${newText.length} å­—`;
                speak(newText);
            }
        }

        function speak(customText) {
            const text = (customText ?? textInput.value).trim();
            if (!text) {
                updateStatus('è¯·å…ˆè¾“å…¥è¦æ’­æŠ¥çš„å†…å®¹', '');
                return;
            }

            // åœæ­¢å½“å‰æ’­æ”¾
            synth.cancel();

            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = parseFloat(speedSlider.value);
            utterance.pitch = 1;
            utterance.volume = 1;

            // å°è¯•è·å–ä¸­æ–‡è¯­éŸ³
            const voices = synth.getVoices();
            const chineseVoice = voices.find(v => v.lang.includes('zh'));
            if (chineseVoice) {
                utterance.voice = chineseVoice;
            }

            utterance.onstart = () => {
                isPlaying = true;
                isPaused = false;
                stopBtn.disabled = false;
                updatePlayButton();
                updateStatus('æ­£åœ¨æ’­æ”¾...', 'playing');
            };

            utterance.onend = () => {
                isPlaying = false;
                isPaused = false;
                stopBtn.disabled = true;
                updatePlayButton();
                updateStatus('æ’­æ”¾å®Œæˆ', '');
            };

            utterance.onerror = (event) => {
                console.error('Speech error:', event.error);
                isPlaying = false;
                isPaused = false;
                stopBtn.disabled = true;
                updatePlayButton();
                updateStatus('æ’­æ”¾å‡ºé”™ï¼Œè¯·é‡è¯•', '');
            };

            utterance.onpause = () => {
                updateStatus('å·²æš‚åœ', 'paused');
            };

            utterance.onresume = () => {
                updateStatus('æ­£åœ¨æ’­æ”¾...', 'playing');
            };

            synth.speak(utterance);
        }

        function stopSpeaking() {
            if (customAudio) {
                try { customAudio.pause(); } catch (e) { /* ignore */ }
                customAudio = null;
            }
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            stopBtn.disabled = true;
            updatePlayButton();
            updateStatus('å·²åœæ­¢', '');
        }

        // é¡µé¢åŠ è½½æ—¶è·å–è¯­éŸ³åˆ—è¡¨
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                const voices = synth.getVoices();
                const chineseVoice = voices.find(v => v.lang.includes('zh'));
                if (chineseVoice) {
                    console.log('ä½¿ç”¨ä¸­æ–‡è¯­éŸ³:', chineseVoice.name);
                }
            };
        }

        // é¡µé¢å¸è½½æ—¶åœæ­¢æ’­æ”¾
        window.addEventListener('beforeunload', () => {
            synth.cancel();
        });

        // é«˜çº§æ’­æŠ¥è®¾ç½®å­˜å‚¨
        const LS_KEY = 'yobox-reader-custom-api';
        function saveCustomConfig() {
            const payload = {
                enabled: !!enableCustomApi.checked,
                apiUrl: customApiUrl.value.trim(),
                apiKey: customApiKey.value.trim(),
                model: customModel.value.trim(),
                responseMode: customResponseMode.value
            };
            try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch (e) { /* ignore */ }
        }

        function loadCustomConfig() {
            let cfg = null;
            try { cfg = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch (e) { /* ignore */ }
            if (!cfg) return;
            enableCustomApi.checked = !!cfg.enabled;
            customApiUrl.value = cfg.apiUrl || '';
            customApiKey.value = cfg.apiKey || '';
            customModel.value = cfg.model || '';
            if (cfg.responseMode) customResponseMode.value = cfg.responseMode;
            customApiPanel.style.display = enableCustomApi.checked ? 'grid' : 'none';
        }

        enableCustomApi.addEventListener('change', () => {
            customApiPanel.style.display = enableCustomApi.checked ? 'grid' : 'none';
            saveCustomConfig();
        });
        [customApiUrl, customApiKey, customModel, customResponseMode].forEach(el => {
            el.addEventListener('change', saveCustomConfig);
            el.addEventListener('input', saveCustomConfig);
        });

        // åˆå§‹åŒ–
        loadCustomConfig();
        updateStatus('å‡†å¤‡å°±ç»ª', '');
    </script>

</body>
</html>
