<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€å¹´çº§ç”Ÿå­—å­—å¸– (é˜¿é‡Œæé€Ÿæº V8.0)</title>
    
    <!-- æ ·å¼ä¿æŒç²¾ç®€ä¸å˜ -->
    <style>
        :root { --bg-color: #f0f2f5; --sidebar-width: 320px; --accent-color: #007aff; --text-primary: #1c1c1e; --grid-color: #2c8a4c; --grid-dash: #a1dcb6; --text-red: #ff3b30; --text-trace: #d1d1d6; }
        body { margin: 0; padding: 0; font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg-color); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #e0e0e0; padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; z-index: 100; box-shadow: 2px 0 8px rgba(0,0,0,0.02); }
        h2 { font-size: 18px; margin: 0 0 10px 0; color: var(--text-primary); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        .label { font-size: 12px; color: #888; font-weight: 600; }
        input, textarea, select { padding: 8px 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }
        textarea { height: 60px; resize: none; }
        .btn-print { background: var(--accent-color); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: auto; font-size: 16px; }
        .btn-print:hover { background: #0062cc; }
        
        .preview-area { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 30px; position: relative; background-color: #f0f2f5; }
        .sheet { width: 210mm; height: 296mm; background: white; padding: 15mm 12mm; box-sizing: border-box; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .sheet-header { height: 15mm; border-bottom: 2px solid var(--grid-color); display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 5px; margin-bottom: 5mm; font-family: "KaiTi", "æ¥·ä½“", serif; font-size: 16px; }
        .header-line { border-bottom: 1px solid #000; width: 60px; display: inline-block; }
        .sheet-content { flex: 1; display: flex; flex-direction: column; }
        .char-block { margin-bottom: 4mm; break-inside: avoid; }
        .row { display: flex; height: 18mm; border-left: 1px solid var(--grid-color); }
        .row.practice { border-top: none; }
        .cell-group { width: 13mm; height: 100%; position: relative; border-right: 1px solid var(--grid-color); border-bottom: 1px solid var(--grid-color); border-top: 1px solid var(--grid-color); display: flex; flex-direction: column; }
        .pinyin { height: 5mm; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; border-bottom: 1px dashed var(--grid-dash); }
        .hanzi { height: 13mm; position: relative; }
        .grid-bg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
        .char-svg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; padding: 8%; box-sizing: border-box; }

        #log-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 20px; border-radius: 20px; font-size: 13px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 999; }
        
        @media print {
            @page { size: A4 portrait; margin: 0; }
            .sidebar, #log-overlay { display: none; }
            .preview-area { padding: 0; margin: 0; width: 210mm; background: white; }
            .sheet { box-shadow: none; margin: 0; page-break-after: always; }
        }
    </style>

    <!-- 1. æ ¸å¿ƒåº“ï¼šå¼ºåˆ¶ä½¿ç”¨é˜¿é‡Œ npmmirror æº (å›½å†…è®¿é—®æå¿«) -->
    <!-- Hanzi Writer -->
    <script src="https://registry.npmmirror.com/hanzi-writer/3.5.0/files/dist/hanzi-writer.min.js"></script>
    <!-- Pinyin Pro -->
    <script src="https://registry.npmmirror.com/pinyin-pro/3.18.2/files/dist/index.min.js"></script>

</head>
<body>
    <div id="log-overlay">å‡†å¤‡å°±ç»ª</div>

    <aside class="sidebar">
        <h2>å­—å¸–ç”Ÿæˆå™¨ V8.0 (å›½å†…ç‰ˆ)</h2>
        <div class="control-group">
            <span class="label">æ•™æ / å†…å®¹</span>
            <select id="textbook" onchange="loadTextbook()">
                <option value="">-- å¿«æ·é€‰æ‹© --</option>
                <option value="å¤©åœ°äººä½ æˆ‘ä»–">è¯†å­—1: å¤©åœ°äºº</option>
                <option value="é‡‘æœ¨æ°´ç«åœŸ">è¯†å­—2: é‡‘æœ¨æ°´ç«åœŸ</option>
                <option value="æ˜¥å¤ç§‹å†¬">ä¸‹å†Œ: æ˜¥å¤ç§‹å†¬</option>
            </select>
            <textarea id="inputStr" placeholder="åœ¨æ­¤è¾“å…¥æ±‰å­—...">å¤©åœ°äººä½ æˆ‘ä»–</textarea>
        </div>
        <div class="control-group">
            <span class="label">æ’ç‰ˆå¯†åº¦</span>
            <select id="density" onchange="debouncedRender()">
                <option value="6">æ ‡å‡† (æ¯é¡µ6å­—)</option>
                <option value="7">ç´§å‡‘ (æ¯é¡µ7å­—)</option>
            </select>
        </div>
        <div class="control-group">
            <span class="label">ç»ƒä¹ æ¨¡å¼</span>
            <select id="mode" onchange="debouncedRender()">
                <option value="progressive">æ¸éšæ¨¡å¼ (æ¨è)</option>
                <option value="trace">å…¨æçº¢</option>
                <option value="empty">å…¨ç©ºç™½</option>
            </select>
        </div>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ç«‹å³æ‰“å°</button>
        <div style="margin-top:20px; font-size:12px; color:#999; text-align:center;">
            æ•°æ®æº: é˜¿é‡Œäº‘é•œåƒ<br>ç”Ÿæˆé€Ÿåº¦å–å†³äºæœ¬åœ°ç½‘ç»œ
        </div>
    </aside>

    <main class="preview-area" id="previewArea"></main>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        const logDiv = document.getElementById('log-overlay');
        function log(msg) {
            logDiv.innerText = msg;
            logDiv.style.opacity = 1;
            setTimeout(() => logDiv.style.opacity = 0, 2000);
        }

        // 2. å…³é”®ä¼˜åŒ–ï¼šé‡å†™æ•°æ®åŠ è½½å™¨ï¼Œå¼ºåˆ¶èµ°é˜¿é‡Œæº
        window.HanziWriterDefaultOptions = {
            charDataLoader: function(char, onComplete, onErr) {
                // æ„é€ é˜¿é‡Œ npmmirror çš„æ•°æ®åœ°å€
                // hanzi-writer-data ç‰ˆæœ¬ 2.0.1
                const url = `https://registry.npmmirror.com/hanzi-writer-data/2.0.1/files/data/${char}.json`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('Network error');
                        return response.json();
                    })
                    .then(onComplete)
                    .catch(err => {
                        console.error('é˜¿é‡ŒæºåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº...', err);
                        // å¤‡ç”¨ï¼šjsdelivr (è™½ç„¶æ…¢ä½†ä½œä¸ºå…œåº•)
                        fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`)
                            .then(res => res.json())
                            .then(onComplete)
                            .catch(onErr);
                    });
            }
        };

        const { pinyin } = pinyinPro;
        const inputStr = document.getElementById('inputStr');
        const previewArea = document.getElementById('previewArea');
        const COLS = 13; 
        let timer;

        window.onload = () => { render(); };
        inputStr.addEventListener('input', debouncedRender);

        function debouncedRender() {
            clearTimeout(timer);
            timer = setTimeout(render, 500);
        }

        function loadTextbook() {
            const val = document.getElementById('textbook').value;
            if(val) { inputStr.value = val; debouncedRender(); }
        }

        async function render() {
            log('æ­£åœ¨ç”Ÿæˆ...');
            const text = inputStr.value.replace(/\s/g, '');
            const chars = Array.from(new Set(text.split('')));
            const mode = document.getElementById('mode').value;
            const itemsPerPage = parseInt(document.getElementById('density').value);
            
            previewArea.innerHTML = '';
            if (chars.length === 0) return;

            const totalPages = Math.ceil(chars.length / itemsPerPage);

            for (let p = 0; p < totalPages; p++) {
                const sheet = document.createElement('div');
                sheet.className = 'sheet';
                sheet.innerHTML = `
                    <div class="sheet-header">
                        <div class="header-item"><span>ä¸€å¹´çº§ç”Ÿå­—ç»ƒä¹ </span></div>
                        <div class="header-item"><span>æ—¥æœŸ:</span><span class="header-line"></span><span>è¯„åˆ†:</span><span class="header-line" style="width:40px"></span></div>
                    </div>
                    <div class="sheet-content"></div>
                `;
                const content = sheet.querySelector('.sheet-content');
                const pageChars = chars.slice(p * itemsPerPage, (p + 1) * itemsPerPage);

                for (let char of pageChars) {
                    try {
                        const data = await HanziWriter.loadCharacterData(char);
                        content.appendChild(createCharBlock(char, data, mode));
                    } catch (e) {
                        const err = document.createElement('div');
                        err.innerText = `${char} åŠ è½½å¤±è´¥`; err.style.color='red';
                        content.appendChild(err);
                    }
                }
                previewArea.appendChild(sheet);
            }
            log('ç”Ÿæˆå®Œæ¯•');
        }

        function createCharBlock(char, data, mode) {
            const block = document.createElement('div');
            block.className = 'char-block';
            const strokes = data.strokes;
            const py = pinyin(char);

            // Row 1
            const row1 = document.createElement('div');
            row1.className = 'row';
            for(let i=0; i<COLS; i++) {
                let type='empty', step=-1;
                if(i===0) type='black';
                else if(i<=strokes.length) { type='step'; step=i-1; }
                else type='trace';
                row1.appendChild(createCell(strokes, py, type, step, i===0));
            }
            block.appendChild(row1);

            // Row 2
            const row2 = document.createElement('div');
            row2.className = 'row practice';
            for(let i=0; i<COLS; i++) {
                let type='empty', opacity=1;
                if(i===0) type='black';
                else {
                    if(mode==='trace') type='trace';
                    else if(mode==='empty') type='empty';
                    else if(mode==='progressive') {
                        if(i<4) { type='trace'; opacity=0.8; }
                        else if(i<8) { type='trace'; opacity=0.3; }
                        else type='empty';
                    }
                }
                const cell = createCell(strokes, '', type, -1, false);
                if(type==='trace' && opacity!==1) cell.querySelector('path').style.opacity = opacity;
                row2.appendChild(cell);
            }
            block.appendChild(row2);
            return block;
        }

        function createCell(strokes, pyStr, mode, step, showCount) {
            const cell = document.createElement('div');
            cell.className = 'cell-group';
            const pDiv = document.createElement('div');
            pDiv.className = 'pinyin'; pDiv.innerText = pyStr || '';
            if(showCount) {
                const count = document.createElement('span');
                count.style.cssText = "position:absolute; right:2px; top:1px; font-size:8px; color:#999;";
                count.innerText = strokes.length;
                pDiv.appendChild(count);
            }
            cell.appendChild(pDiv);
            const hDiv = document.createElement('div');
            hDiv.className = 'hanzi';
            hDiv.innerHTML = `<svg class="grid-bg" width="100%" height="100%"><line x1="0" y1="50%" x2="100%" y2="50%" stroke="var(--grid-dash)" stroke-dasharray="4,4"/><line x1="50%" y1="0" x2="50%" y2="100%" stroke="var(--grid-dash)" stroke-dasharray="4,4"/></svg>`;
            if(strokes && mode !== 'empty') {
                let paths = '';
                strokes.forEach((p, idx) => {
                    let color = 'var(--text-primary)';
                    if(mode==='trace') color='var(--text-trace)';
                    else if(mode==='step') {
                        if(idx<step) color='var(--text-trace)';
                        else if(idx===step) color='var(--text-red)';
                        else return;
                    }
                    paths += `<path d="${p}" fill="${color}"/>`;
                });
                hDiv.insertAdjacentHTML('beforeend', `<svg class="char-svg" viewBox="0 0 1024 1024"><g transform="scale(1, -1) translate(0, -900)">${paths}</g></svg>`);
            }
            cell.appendChild(hDiv);
            return cell;
        }
    </script>
</body>
</html>
