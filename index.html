<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€å¹´çº§ç”Ÿå­—å­—å¸– (V10.0 ç»ˆæå†…åµŒç‰ˆ)</title>
    <style>
        /* æ ·å¼ä¿æŒç²¾ç®€ */
        :root { --bg-color: #f5f7fa; --sidebar-width: 300px; --accent-color: #007aff; --text-primary: #333; --grid-color: #2c8a4c; --grid-dash: #a1dcb6; --text-red: #ff3b30; --text-trace: #d1d1d6; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; background: var(--bg-color); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #e0e0e0; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.03); }
        h2 { font-size: 18px; margin: 0; color: var(--text-primary); border-left: 4px solid var(--accent-color); padding-left: 10px; line-height: 1; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        .label { font-size: 12px; color: #888; font-weight: bold; }
        input, textarea, select { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        textarea { height: 80px; resize: none; }
        .btn-print { background: var(--accent-color); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: auto; font-size: 16px; transition: background 0.2s; }
        .btn-print:hover { background: #0056b3; }
        .preview-area { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 30px; position: relative; }
        .sheet { width: 210mm; height: 296mm; background: white; padding: 15mm 12mm; box-sizing: border-box; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .sheet-header { height: 15mm; border-bottom: 2px solid var(--grid-color); display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 5px; margin-bottom: 5mm; font-family: "KaiTi", "æ¥·ä½“", serif; font-size: 16px; }
        .header-line { border-bottom: 1px solid #000; width: 60px; display: inline-block; }
        .sheet-content { flex: 1; display: flex; flex-direction: column; }
        .char-block { margin-bottom: 4mm; break-inside: avoid; }
        .row { display: flex; height: 18mm; border-left: 1px solid var(--grid-color); }
        .row.practice { border-top: none; }
        .cell-group { width: 13mm; height: 100%; position: relative; border-right: 1px solid var(--grid-color); border-bottom: 1px solid var(--grid-color); border-top: 1px solid var(--grid-color); display: flex; flex-direction: column; }
        .pinyin { height: 5mm; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; border-bottom: 1px dashed var(--grid-dash); }
        .hanzi { height: 13mm; position: relative; }
        .grid-bg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
        .char-svg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; padding: 8%; box-sizing: border-box; }
        #status-bar { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 30px; font-size: 14px; z-index: 999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        @media print { @page { size: A4 portrait; margin: 0; } .sidebar, #status-bar { display: none; } .preview-area { padding: 0; margin: 0; width: 210mm; background: white; } .sheet { box-shadow: none; margin: 0; page-break-after: always; } }
    </style>
    
    <!-- æ ¸å¿ƒåº“æ”¹ä¸º jsdelivr (ç›®å‰æœ€ç¨³) -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.2/dist/index.min.js"></script>
</head>
<body>
    <div id="status-bar">å‡†å¤‡å°±ç»ª</div>

    <aside class="sidebar">
        <h2>å­—å¸–ç”Ÿæˆå™¨ V10.0</h2>
        <div class="control-group">
            <span class="label">æ•™æ / å†…å®¹</span>
            <select id="textbook" onchange="loadTextbook()">
                <option value="">-- å¿«æ·é€‰æ‹© --</option>
                <option value="å¤©åœ°äººä½ æˆ‘ä»–">è¯†å­—1: å¤©åœ°äºº</option>
                <option value="é‡‘æœ¨æ°´ç«åœŸ">è¯†å­—2: é‡‘æœ¨æ°´ç«åœŸ</option>
                <option value="æ˜¥å¤ç§‹å†¬">ä¸‹å†Œ: æ˜¥å¤ç§‹å†¬</option>
            </select>
            <textarea id="inputStr" placeholder="åœ¨æ­¤è¾“å…¥æ±‰å­—...">å¤©åœ°äººä½ æˆ‘ä»–</textarea>
        </div>
        <div class="control-group">
            <span class="label">æ’ç‰ˆå¯†åº¦</span>
            <select id="density" onchange="debouncedRender()">
                <option value="6">æ ‡å‡† (æ¯é¡µ6å­—)</option>
                <option value="7">ç´§å‡‘ (æ¯é¡µ7å­—)</option>
            </select>
        </div>
        <div class="control-group">
            <span class="label">ç»ƒä¹ æ¨¡å¼</span>
            <select id="mode" onchange="debouncedRender()">
                <option value="progressive">æ¸éšæ¨¡å¼ (æ¨è)</option>
                <option value="trace">å…¨æçº¢</option>
                <option value="empty">å…¨ç©ºç™½</option>
            </select>
        </div>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ç«‹å³æ‰“å°</button>
        <div style="font-size:12px; color:#999; text-align:center; margin-top:10px;">
            å¤šæºè‡ªåŠ¨åˆ‡æ¢ (GitHub/CDN)
        </div>
    </aside>

    <main class="preview-area" id="previewArea"></main>

    <script>
        const statusBar = document.getElementById('status-bar');
        function showStatus(msg, isError=false) {
            statusBar.innerText = msg;
            statusBar.style.opacity = 1;
            statusBar.style.background = isError ? '#ff3b30' : 'rgba(0,0,0,0.8)';
            if(!isError) setTimeout(() => statusBar.style.opacity = 0, 2000);
        }

        // ç»ˆææ•°æ®åŠ è½½å™¨ï¼šè½®è¯¢æœºåˆ¶
        // ä¾æ¬¡å°è¯•ï¼šjsDelivr -> unpkg -> é¥¿äº†ä¹ˆ -> GitHub Raw
        window.HanziWriterDefaultOptions = {
            charDataLoader: async function(char, onComplete, onErr) {
                const sources = [
                    `https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`,
                    `https://unpkg.com/hanzi-writer-data@2.0/${char}.json`,
                    `https://npm.elemecdn.com/hanzi-writer-data@2.0/${char}.json`
                ];

                for (let url of sources) {
                    try {
                        const res = await fetch(url);
                        if (res.ok) {
                            const data = await res.json();
                            onComplete(data);
                            return; // æˆåŠŸå°±é€€å‡º
                        }
                    } catch (e) {
                        // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
                    }
                }
                onErr("æ‰€æœ‰æºéƒ½å¤±è´¥");
            }
        };

        const { pinyin } = pinyinPro || { pinyin: (c)=>c }; // å®¹é”™
        const inputStr = document.getElementById('inputStr');
        const previewArea = document.getElementById('previewArea');
        const COLS = 13; 
        let timer;

        // åˆå§‹åŒ–æ£€æµ‹
        window.onload = () => {
            if (typeof HanziWriter === 'undefined') {
                document.getElementById('previewArea').innerHTML = `
                    <div style="text-align:center; margin-top:50px; color:red;">
                        <h3>ğŸ’¥ è‡´å‘½é”™è¯¯</h3>
                        <p>æ— æ³•åŠ è½½æ ¸å¿ƒç»„ä»¶ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ VPN è®¾ç½®ã€‚</p>
                        <p>å¦‚æœæ‚¨åœ¨ä¸­å›½å¤§é™†ï¼Œè¯·å°è¯•ä½¿ç”¨â€œå…¨å±€æ¨¡å¼â€ã€‚</p>
                    </div>
                `;
            } else {
                render();
            }
        };

        inputStr.addEventListener('input', debouncedRender);

        function debouncedRender() {
            clearTimeout(timer);
            timer = setTimeout(render, 500);
        }

        function loadTextbook() {
            const val = document.getElementById('textbook').value;
            if(val) { inputStr.value = val; debouncedRender(); }
        }

        async function render() {
            showStatus('æ­£åœ¨ç”Ÿæˆ...');
            const text = inputStr.value.replace(/\s/g, '');
            const chars = Array.from(new Set(text.split('')));
            const mode = document.getElementById('mode').value;
            const itemsPerPage = parseInt(document.getElementById('density').value);
            
            previewArea.innerHTML = '';
            if (chars.length === 0) return;

            const totalPages = Math.ceil(chars.length / itemsPerPage);

            for (let p = 0; p < totalPages; p++) {
                const sheet = document.createElement('div');
                sheet.className = 'sheet';
                sheet.innerHTML = `
                    <div class="sheet-header">
                        <div class="header-item"><span>ä¸€å¹´çº§ç”Ÿå­—ç»ƒä¹ </span></div>
                        <div class="header-item"><span>æ—¥æœŸ:</span><span class="header-line"></span><span>è¯„åˆ†:</span><span class="header-line" style="width:40px"></span></div>
                    </div>
                    <div class="sheet-content"></div>
                `;
                const content = sheet.querySelector('.sheet-content');
                const pageChars = chars.slice(p * itemsPerPage, (p + 1) * itemsPerPage);

                for (let char of pageChars) {
                    try {
                        const data = await HanziWriter.loadCharacterData(char);
                        content.appendChild(createCharBlock(char, data, mode));
                    } catch (e) {
                        const err = document.createElement('div');
                        err.innerHTML = `<span style="color:red">[${char}]</span> åŠ è½½å¤±è´¥`; 
                        err.style.padding='10px';
                        content.appendChild(err);
                    }
                }
                previewArea.appendChild(sheet);
            }
            showStatus('ç”Ÿæˆå®Œæ¯•');
        }

        function createCharBlock(char, data, mode) {
            const block = document.createElement('div');
            block.className = 'char-block';
            const strokes = data.strokes;
            const py = pinyin(char);

            // Row 1
            const row1 = document.createElement('div');
            row1.className = 'row';
            for(let i=0; i<COLS; i++) {
                let type='empty', step=-1;
                if(i===0) type='black';
                else if(i<=strokes.length) { type='step'; step=i-1; }
                else type='trace';
                row1.appendChild(createCell(strokes, py, type, step, i===0));
            }
            block.appendChild(row1);

            // Row 2
            const row2 = document.createElement('div');
            row2.className = 'row practice';
            for(let i=0; i<COLS; i++) {
                let type='empty', opacity=1;
                if(i===0) type='black';
                else {
                    if(mode==='trace') type='trace';
                    else if(mode==='empty') type='empty';
                    else if(mode==='progressive') {
                        if(i<4) { type='trace'; opacity=0.8; }
                        else if(i<8) { type='trace'; opacity=0.3; }
                        else type='empty';
                    }
                }
                const cell = createCell(strokes, '', type, -1, false);
                if(type==='trace' && opacity!==1) cell.querySelector('path').style.opacity = opacity;
                row2.appendChild(cell);
            }
            block.appendChild(row2);
            return block;
        }

        function createCell(strokes, pyStr, mode, step, showCount) {
            const cell = document.createElement('div');
            cell.className = 'cell-group';
            const pDiv = document.createElement('div');
            pDiv.className = 'pinyin'; pDiv.innerText = pyStr || '';
            if(showCount) {
                const count = document.createElement('span');
                count.style.cssText = "position:absolute; right:2px; top:1px; font-size:8px; color:#999;";
                count.innerText = strokes.length;
                pDiv.appendChild(count);
            }
            cell.appendChild(pDiv);
            const hDiv = document.createElement('div');
            hDiv.className = 'hanzi';
            hDiv.innerHTML = `<svg class="grid-bg" width="100%" height="100%"><line x1="0" y1="50%" x2="100%" y2="50%" stroke="var(--grid-dash)" stroke-dasharray="4,4"/><line x1="50%" y1="0" x2="50%" y2="100%" stroke="var(--grid-dash)" stroke-dasharray="4,4"/></svg>`;
            if(strokes && mode !== 'empty') {
                let paths = '';
                strokes.forEach((p, idx) => {
                    let color = 'var(--text-primary)';
                    if(mode==='trace') color='var(--text-trace)';
                    else if(mode==='step') {
                        if(idx<step) color='var(--text-trace)';
                        else if(idx===step) color='var(--text-red)';
                        else return;
                    }
                    paths += `<path d="${p}" fill="${color}"/>`;
                });
                hDiv.insertAdjacentHTML('beforeend', `<svg class="char-svg" viewBox="0 0 1024 1024"><g transform="scale(1, -1) translate(0, -900)">${paths}</g></svg>`);
            }
            cell.appendChild(hDiv);
            return cell;
        }
    </script>
</body>
</html>
