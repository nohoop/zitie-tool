<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€å¹´çº§ç”Ÿå­—å­—å¸– (V7.2 åšå¼ºç‰ˆ)</title>
    
    <!-- 
      === æ ¸å¿ƒä¿®æ”¹ï¼šCDN æºæ›¿æ¢ ===
      ç”±äº jsdelivr åœ¨å›½å†…ä¸ç¨³å®šï¼Œæˆ‘ä»¬æ”¹ç”¨ unpkg (è™½ç„¶æ…¢ä½†é€šå¸¸èƒ½è¿) 
      æˆ–è€…å°è¯•ä½¿ç”¨è¿™ä¸€å¥—æ··åˆæ–¹æ¡ˆã€‚
    -->
    <script src="https://unpkg.com/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <script src="https://unpkg.com/pinyin-pro@3.18.2/dist/index.min.js"></script>

    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä¹‹å‰çš„æ ·å¼ */
        :root { --bg-color: #e5e5ea; --sidebar-width: 320px; --accent-color: #007aff; --text-primary: #1c1c1e; --grid-color: #2c8a4c; --grid-dash: #a1dcb6; --text-red: #ff3b30; --text-trace: #d1d1d6; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; background: var(--bg-color); display: flex; height: 100vh; overflow: hidden; }
        
        /* é”™è¯¯é®ç½©å±‚ */
        #error-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center; padding: 20px; }
        .error-box { background: #1c1c1e; padding: 30px; border-radius: 12px; max-width: 500px; border: 1px solid #ff3b30; }
        .error-btn { background: #007aff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-top:15px; }

        .sidebar { width: var(--sidebar-width); background: rgba(255,255,255,0.98); border-right: 1px solid #c6c6c8; padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; z-index: 100; }
        h2 { font-size: 18px; margin: 0 0 5px 0; color: var(--text-primary); }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .label { font-size: 12px; color: #8e8e93; font-weight: 600; text-transform: uppercase; }
        input, textarea, select { padding: 8px 10px; border-radius: 8px; border: 1px solid #d1d1d6; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); }
        textarea { height: 60px; resize: none; }
        .btn-print { background: var(--accent-color); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: auto; font-size: 16px; }
        
        .preview-area { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .sheet { width: 210mm; height: 296mm; background: white; padding: 15mm 12mm; box-sizing: border-box; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .sheet-header { height: 15mm; border-bottom: 2px solid var(--grid-color); display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 5px; margin-bottom: 5mm; font-family: "KaiTi", "æ¥·ä½“", serif; font-size: 16px; }
        .header-line { border-bottom: 1px solid #000; width: 60px; display: inline-block; }
        .sheet-content { flex: 1; display: flex; flex-direction: column; }
        .char-block { margin-bottom: 4mm; break-inside: avoid; }
        .row { display: flex; height: 18mm; border-left: 1px solid var(--grid-color); }
        .row.practice { border-top: none; }
        .cell-group { width: 13mm; height: 100%; position: relative; border-right: 1px solid var(--grid-color); border-bottom: 1px solid var(--grid-color); border-top: 1px solid var(--grid-color); display: flex; flex-direction: column; }
        .pinyin { height: 5mm; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; border-bottom: 1px dashed var(--grid-dash); }
        .hanzi { height: 13mm; position: relative; }
        .grid-bg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
        .char-svg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; padding: 8%; box-sizing: border-box; }

        @media print {
            @page { size: A4 portrait; margin: 0; }
            .sidebar, #error-overlay { display: none; }
            .preview-area { padding: 0; margin: 0; width: 210mm; }
            .sheet { box-shadow: none; margin: 0; page-break-after: always; }
        }
    </style>
</head>
<body>

    <div id="error-overlay">
        <div class="error-box">
            <div class="error-title">âš ï¸ ç½‘ç»œåŠ è½½å¤±è´¥</div>
            <div class="error-msg" id="error-text"></div>
            <button class="error-btn" onclick="location.reload()">é‡æ–°åŠ è½½é¡µé¢</button>
        </div>
    </div>

    <aside class="sidebar">
        <h2>å­—å¸–ç”Ÿæˆå™¨ (V7.2)</h2>
        <div class="control-group">
            <span class="label">æ•™æ / å†…å®¹</span>
            <select id="textbook" onchange="loadTextbook()">
                <option value="">-- å¿«æ·é€‰æ‹© --</option>
                <option value="å¤©åœ°äººä½ æˆ‘ä»–">è¯†å­—1: å¤©åœ°äºº</option>
                <option value="é‡‘æœ¨æ°´ç«åœŸ">è¯†å­—2: é‡‘æœ¨æ°´ç«åœŸ</option>
                <option value="æ˜¥å¤ç§‹å†¬">ä¸‹å†Œ: æ˜¥å¤ç§‹å†¬</option>
            </select>
            <textarea id="inputStr" placeholder="åœ¨æ­¤è¾“å…¥æ±‰å­—...">å¤©åœ°äººä½ æˆ‘ä»–</textarea>
        </div>
        <div class="control-group">
            <span class="label">æ’ç‰ˆå¯†åº¦</span>
            <select id="density" onchange="debouncedRender()">
                <option value="6">æ ‡å‡† (æ¯é¡µ6å­—)</option>
                <option value="7">ç´§å‡‘ (æ¯é¡µ7å­—)</option>
            </select>
        </div>
        <div class="control-group">
            <span class="label">ç»ƒä¹ æ¨¡å¼</span>
            <select id="mode" onchange="debouncedRender()">
                <option value="progressive">æ¸éšæ¨¡å¼ (æ¨è)</option>
                <option value="trace">å…¨æçº¢</option>
                <option value="empty">å…¨ç©ºç™½</option>
            </select>
        </div>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ç«‹å³æ‰“å°</button>
    </aside>

    <main class="preview-area" id="previewArea">
        <div style="margin-top:100px; color:#999;">æ­£åœ¨è¿æ¥èµ„æºåº“...</div>
    </main>

    <script>
        // é”™è¯¯å¤„ç†
        const errorOverlay = document.getElementById('error-overlay');
        const errorText = document.getElementById('error-text');

        function showError(msg) {
            errorOverlay.style.display = 'flex';
            errorText.innerHTML = msg;
        }

        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
        if (typeof HanziWriter === 'undefined' || typeof pinyinPro === 'undefined') {
            showError("æ— æ³•è¿æ¥åˆ°èµ„æºåº“ (unpkg)ã€‚<br>å¯èƒ½æ˜¯æ‚¨çš„ç½‘ç»œæ— æ³•è®¿é—® GitHub/CDNã€‚<br>å»ºè®®å°è¯•åˆ‡æ¢ç½‘ç»œæˆ–ä½¿ç”¨ VPNã€‚");
        }

        // æ•°æ®åŠ è½½ä¼˜åŒ–ï¼šä½¿ç”¨ unpkg æ›¿ä»£ GitHub Raw
        window.HanziWriterDefaultOptions = {
            charDataLoader: function(char, onComplete, onErr) {
                // å°è¯•ä» unpkg åŠ è½½æ•°æ®
                fetch('https://unpkg.com/hanzi-writer-data@2.0/' + char + '.json')
                    .then(res => {
                        if (!res.ok) throw new Error('Failed');
                        return res.json();
                    })
                    .then(onComplete)
                    .catch(() => {
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœ unpkg æŒ‚äº†ï¼Œå°è¯• jsdelivr
                        fetch('https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/' + char + '.json')
                        .then(res => res.json())
                        .then(onComplete)
                        .catch(onErr);
                    });
            }
        };

        const { pinyin } = pinyinPro;
        const inputStr = document.getElementById('inputStr');
        const previewArea = document.getElementById('previewArea');
        const COLS = 13; 
        let timer;

        window.onload = () => { try { render(); } catch(e){ showError(e.message); } };
        inputStr.addEventListener('input', debouncedRender);

        function debouncedRender() {
            clearTimeout(timer);
            timer = setTimeout(render, 500);
        }

        function loadTextbook() {
            const val = document.getElementById('textbook').value;
            if(val) { inputStr.value = val; debouncedRender(); }
        }

        async function render() {
            const text = inputStr.value.replace(/\s/g, '');
            const chars = Array.from(new Set(text.split('')));
            const mode = document.getElementById('mode').value;
            const itemsPerPage = parseInt(document.getElementById('density').value);
            
            previewArea.innerHTML = '';
            if (chars.length === 0) return;

            const totalPages = Math.ceil(chars.length / itemsPerPage);

            for (let p = 0; p < totalPages; p++) {
                const sheet = document.createElement('div');
                sheet.className = 'sheet';
                
                sheet.innerHTML = `
                    <div class="sheet-header">
                        <div class="header-item"><span>ä¸€å¹´çº§ç”Ÿå­—ç»ƒä¹ </span></div>
                        <div class="header-item">
                            <span>æ—¥æœŸ:</span><span class="header-line"></span>
                            <span>è¯„åˆ†:</span><span class="header-line" style="width:40px"></span>
                        </div>
                    </div>
                    <div class="sheet-content"></div>
                `;

                const content = sheet.querySelector('.sheet-content');
                const start = p * itemsPerPage;
                const end = Math.min(start + itemsPerPage, chars.length);
                const pageChars = chars.slice(start, end);

                for (let char of pageChars) {
                    try {
                        const data = await HanziWriter.loadCharacterData(char);
                        const block = createCharBlock(char, data, mode);
                        content.appendChild(block);
                    } catch (err) {
                        const errorDiv = document.createElement('div');
                        errorDiv.innerText = `[${char}] åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ`;
                        errorDiv.style.color = 'red'; errorDiv.style.padding='10px';
                        content.appendChild(errorDiv);
                    }
                }
                previewArea.appendChild(sheet);
            }
        }

        function createCharBlock(char, data, mode) {
            const block = document.createElement('div');
            block.className = 'char-block';
            const strokes = data.strokes;
            const py = pinyin(char);

            // Row 1
            const row1 = document.createElement('div');
            row1.className = 'row';
            for(let i=0; i<COLS; i++) {
                let type='empty', step=-1;
                if(i===0) type='black';
                else if(i<=strokes.length) { type='step'; step=i-1; }
                else type='trace';
                row1.appendChild(createCell(strokes, py, type, step, i===0));
            }
            block.appendChild(row1);

            // Row 2
            const row2 = document.createElement('div');
            row2.className = 'row practice';
            for(let i=0; i<COLS; i++) {
                let type='empty', opacity=1;
                if(i===0) type='black';
                else {
                    if(mode==='trace') type='trace';
                    else if(mode==='empty') type='empty';
                    else if(mode==='progressive') {
                        if(i<4) { type='trace'; opacity=0.8; }
                        else if(i<8) { type='trace'; opacity=0.3; }
                        else type='empty';
                    }
                }
                const cell = createCell(strokes, '', type, -1, false);
                if(type==='trace' && opacity!==1) {
                    const path = cell.querySelector('path');
                    if(path) path.style.opacity = opacity;
                }
                row2.appendChild(cell);
            }
            block.appendChild(row2);
            return block;
        }

        function createCell(strokes, pyStr, mode, step, showCount) {
            const cell = document.createElement('div');
            cell.className = 'cell-group';
            const pDiv = document.createElement('div');
            pDiv.className = 'pinyin'; pDiv.innerText = pyStr || '';
            if(showCount) {
                const count = document.createElement('span');
                count.style.cssText = "position:absolute; right:2px; top:1px; font-size:8px; color:#999;";
                count.innerText = strokes.length;
                pDiv.appendChild(count);
            }
            cell.appendChild(pDiv);
            const hDiv = document.createElement('div');
            hDiv.className = 'hanzi';
            hDiv.innerHTML = `<svg class="grid-bg" width="100%" height="100%"><line x1="0" y1="50%" x2="100%" y2="50%" stroke="var(--grid-dash)" stroke-dasharray="4,4"/><line x1="50%" y1="0" x2="50%" y2="100%" stroke="var(--grid-dash)" stroke-dasharray="4,4"/></svg>`;
            if(strokes && mode !== 'empty') {
                let paths = '';
                strokes.forEach((p, idx) => {
                    let color = 'var
