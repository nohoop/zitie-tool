<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YoBox å¬å†™åŠ©æ‰‹</title>
    
    <!-- å¼•å…¥æ‹¼éŸ³åº“ (ç”¨äºç”Ÿæˆæ‰“å°çº¸çš„æ‹¼éŸ³æç¤º) -->
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.2/dist/index.min.js"></script>

    <style>
        :root {
            --bg: #f5f5f7; --white: #fff; --accent: #007aff; 
            --text: #1d1d1f; --border: #d2d2d7; --green: #34c759;
            --grid-ink: #6e6aa8;
            --grid-ink-soft: rgba(110, 106, 168, 0.75);
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--text); }

        .menu-btn {
            position: fixed;
            top: calc(env(safe-area-inset-top, 0px) + 12px);
            left: 12px;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.12);
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .menu-btn:active { transform: scale(0.98); }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 200;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        /* ä¾§è¾¹æ  (è®¾ç½®åŒº) */
        .sidebar {
            width: 320px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column;
            z-index: 100; transition: transform 0.3s;
        }
        .header { padding: 20px; border-bottom: 1px solid var(--border); position: relative; }
        .back-link { text-decoration: none; color: var(--accent); font-size: 13px; display: flex; align-items: center; gap: 4px; margin-bottom: 10px; font-weight: 500; }
        .title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; }

        .sidebar-close {
            position: absolute;
            right: 12px;
            top: calc(env(safe-area-inset-top, 0px) + 10px);
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.10);
            background: rgba(118,118,128,0.14);
            color: var(--text);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }
        
        .content-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        .control-group label { display: block; font-size: 12px; font-weight: 600; color: #888; margin-bottom: 8px; }
        textarea {
            width: 100%; height: 120px; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            background: #f5f5f7; font-size: 16px; outline: none; resize: none; box-sizing: border-box;
        }
        textarea:focus { background: #fff; border-color: var(--accent); }

        /* èƒ¶å›Šé€‰æ‹©å™¨ */
        .capsule-group { display: flex; background: #e5e5ea; padding: 3px; border-radius: 10px; }
        .capsule { 
            flex: 1; text-align: center; padding: 6px; font-size: 13px; border-radius: 8px; cursor: pointer; color: #666;
        }
        .capsule.active { background: #fff; color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 500; }

        .btn-print {
            width: 100%; padding: 12px; background: var(--text); color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: auto;
        }

        /* ä¸»èˆå° (æ’­æ”¾å™¨ + é¢„è§ˆ) */
        .main { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; background: var(--bg); overflow-y: auto; }

        /* æ’­æ”¾å™¨å¡ç‰‡ (iOS Music é£æ ¼) */
        .player-card {
            margin-top: 40px; width: 90%; max-width: 400px;
            background: #fff; border-radius: 24px; padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); text-align: center;
            transition: 0.3s;
        }
        .player-status { font-size: 12px; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .current-word { font-size: 48px; font-weight: 700; margin: 10px 0; height: 60px; line-height: 60px; }
        .progress-info { font-size: 14px; color: #888; margin-bottom: 30px; }
        
        .controls { display: flex; justify-content: center; align-items: center; gap: 30px; }
        .btn-ctrl { background: none; border: none; cursor: pointer; color: var(--text); transition: 0.2s; }
        .btn-ctrl:active { transform: scale(0.9); }
        .btn-play { 
            width: 70px; height: 70px; background: var(--accent); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,122,255,0.3);
        }
        .btn-play svg { width: 30px; height: 30px; fill: currentColor; }

        /* A4 æ‰“å°é¢„è§ˆ (åœ¨å±å¹•ä¸‹æ–¹) */
        .sheet-stack { margin-top: 40px; margin-bottom: 40px; display: flex; flex-direction: column; align-items: center; gap: 24px; }

        /* å‚è€ƒè€å¸ˆç¤ºä¾‹ï¼šA4 æ¨ªå‘ + ç”°å­—æ ¼æ•´é¡µæ’ç‰ˆ */
        .sheet-preview {
            width: 297mm;
            min-height: 210mm;
            background: white;
            padding: 8mm;
            box-sizing: border-box;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .tian-grid-wrap {
            --cols: 14;
            --rows: 9;
            --cell: 20mm;
            width: calc(var(--cols) * var(--cell));
            height: calc(var(--rows) * var(--cell));
            margin: 0 auto;
            position: relative;
        }

        .tian-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(var(--cols), var(--cell));
            grid-template-rows: repeat(var(--rows), var(--cell));
            border: 1.6px solid var(--grid-ink);
        }

        .tian-cell {
            position: relative;
            border-right: 1.2px solid var(--grid-ink);
            border-bottom: 1.2px solid var(--grid-ink);
        }
        .tian-cell:nth-child(14n) { border-right: none; }
        .tian-cell:nth-last-child(-n+14) { border-bottom: none; }

        .tian-cell::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            border-left: 1px dashed var(--grid-ink-soft);
            transform: translateX(-0.5px);
            pointer-events: none;
        }
        .tian-cell::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            border-top: 1px dashed var(--grid-ink-soft);
            transform: translateY(-0.5px);
            pointer-events: none;
        }

        /* ç§»åŠ¨ç«¯ï¼šæŠ½å±‰ä¾§æ ï¼ˆå‚è€ƒâ€œå­—å¸–å·¥åŠâ€ï¼‰ */
        @media (max-width: 860px) {
            .menu-btn { display: inline-flex; }

            body { height: 100dvh; overflow: hidden; }

            .sidebar {
                position: fixed;
                top: 0; left: 0; bottom: 0;
                width: min(320px, 86vw);
                transform: translateX(-105%);
                box-shadow: 2px 0 24px rgba(0,0,0,0.18);
                border-right: 1px solid rgba(0,0,0,0.08);
                z-index: 250;
            }
            .sidebar.open { transform: translateX(0); }
            .sidebar-close { display: inline-flex; }

            .main {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding-top: 68px;
            }

            .player-card { margin-top: 16px; width: 92%; }
            .sheet-stack { margin-top: 20px; margin-bottom: 28px; }
            .sheet-preview { border-radius: 14px; }
        }

        @media print {
            @page { size: A4 landscape; margin: 8mm; }
            body { display: block; height: auto; overflow: visible; background: #fff; }
            .sidebar, .player-card, .menu-btn, .overlay { display: none !important; }
            .main { display: block; overflow: visible; padding: 0; }
            .sheet-stack { margin: 0; gap: 0; }
            .sheet-preview { margin: 0; box-shadow: none; border-radius: 0; padding: 0; width: 100%; min-height: auto; transform: none !important; }
            .sheet-preview + .sheet-preview { page-break-before: always; break-before: page; }
        }
    </style>
</head>
<body>

    <button class="menu-btn" type="button" aria-label="æ‰“å¼€èœå•" onclick="toggleSidebar(true)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="4" y1="7" x2="20" y2="7"></line>
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="17" x2="20" y2="17"></line>
        </svg>
    </button>
    <div class="overlay" id="overlay" onclick="toggleSidebar(false)"></div>

    <aside class="sidebar" id="sidebar">
        <div class="header">
            <button class="sidebar-close" type="button" aria-label="å…³é—­èœå•" onclick="toggleSidebar(false)">Ã—</button>
            <a href="../" class="back-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                è¿”å›å¤§å…
            </a>
            <div class="title">ğŸ™ï¸ å¬å†™åŠ©æ‰‹</div>
        </div>
        
        <div class="content-area">
            <div class="control-group">
                <label>å¬å†™å†…å®¹ (ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”)</label>
                <textarea id="inputWords" placeholder="åœ¨æ­¤ç²˜è´´è¯è¯­ï¼Œå¦‚ï¼š&#10;ä¹¦åŒ… å°ºå­ ä½œä¸šæœ¬&#10;äº”æ˜Ÿçº¢æ——">ä¹ä¸ª å¤§ç‹ ä¸‹åˆ ä¸­åˆ ä¸å» ç‹å­ å¶å­ å¤§äºº å¯æ˜¯ ä¸œè¥¿ ç«¹å­ æœ¨é©¬</textarea>
            </div>

            <div class="control-group">
                <label>æœ—è¯»æ¬¡æ•°</label>
                <div class="capsule-group">
                    <div class="capsule" onclick="setMode(1, this)">è¯»1é</div>
                    <div class="capsule active" onclick="setMode(2, this)">è¯»2é</div>
                    <div class="capsule" onclick="setMode(3, this)">è¯»3é</div>
                </div>
            </div>

            <div class="control-group">
                <label>é—´éš”æ—¶é—´ (ç»™å­©å­å†™å­—çš„æ—¶é—´)</label>
                <div class="capsule-group">
                    <div class="capsule" onclick="setSpeed(5000, this)">5ç§’</div>
                    <div class="capsule active" onclick="setSpeed(8000, this)">8ç§’</div>
                    <div class="capsule" onclick="setSpeed(12000, this)">12ç§’</div>
                </div>
            </div>

            <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°é»˜å†™çº¸</button>
        </div>
    </aside>

    <main class="main">
        <!-- æ’­æ”¾å™¨ -->
        <div class="player-card">
            <div class="player-status" id="statusText">å‡†å¤‡å°±ç»ª</div>
            <div class="current-word" id="displayWord">...</div>
            <div class="progress-info" id="progressText">0 / 0</div>
            
            <div class="controls">
                <button class="btn-ctrl" onclick="prevWord()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5" stroke="currentColor" stroke-width="2"></line></svg>
                </button>
                <button class="btn-play" onclick="togglePlay()" id="playBtn">
                    <svg id="iconPlay" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    <svg id="iconPause" viewBox="0 0 24 24" style="display:none;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                </button>
                <button class="btn-ctrl" onclick="nextWord()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="2"></line></svg>
                </button>
            </div>
        </div>

        <!-- æ‰“å°é¢„è§ˆåŒº -->
        <div class="sheet-stack" id="sheet" aria-label="æ‰“å°é¢„è§ˆ"></div>
    </main>

    <script>
        function toggleSidebar(forceOpen) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if (!sidebar || !overlay) return;
            const open = typeof forceOpen === 'boolean' ? forceOpen : !sidebar.classList.contains('open');
            sidebar.classList.toggle('open', open);
            overlay.classList.toggle('active', open);
        }

        function fitSheetPreview() {
            const stack = document.getElementById('sheet');
            if (!stack) return;
            const isMobile = window.matchMedia('(max-width: 860px)').matches;
            const pages = Array.from(stack.querySelectorAll('.sheet-preview'));
            for (const page of pages) {
                page.style.transform = '';
                page.style.transformOrigin = '';
                page.style.marginBottom = '';
            }
            if (!isMobile || pages.length === 0) return;

            const main = document.querySelector('main.main');
            const available = Math.max(0, (main?.clientWidth || window.innerWidth) - 24);
            const baseWidth = pages[0].offsetWidth;
            if (!baseWidth) return;
            const scale = Math.min(1, available / baseWidth);
            pages.forEach((page, idx) => {
                page.style.transformOrigin = 'top center';
                page.style.transform = `scale(${scale})`;
                const gap = idx === pages.length - 1 ? 28 : 20;
                page.style.marginBottom = `${-(1 - scale) * page.offsetHeight + gap}px`;
            });
        }

        let fitRaf = 0;
        function requestFit() {
            cancelAnimationFrame(fitRaf);
            fitRaf = requestAnimationFrame(fitSheetPreview);
        }
        window.addEventListener('resize', () => {
            if (!window.matchMedia('(max-width: 860px)').matches) toggleSidebar(false);
            requestFit();
        });
        window.addEventListener('orientationchange', requestFit);
        
        // çŠ¶æ€å˜é‡
        let words = [];
        let currentIndex = 0;
        let isPlaying = false;
        let repeatTimes = 2;
        let intervalTime = 8000;
        let timeoutId = null;
        let synth = window.speechSynthesis;

        // DOM å…ƒç´ 
        const inputEl = document.getElementById('inputWords');
        const displayEl = document.getElementById('displayWord');
        const progressEl = document.getElementById('progressText');
        const statusEl = document.getElementById('statusText');
        const sheetEl = document.getElementById('sheet');
        const btnPlay = document.getElementById('playBtn');

        // åˆå§‹åŒ–
        inputEl.addEventListener('input', initData);
        window.onload = initData;

        function initData() {
            // è§£æè¯è¯­ï¼ˆæ”¯æŒç©ºæ ¼ã€æ¢è¡Œã€é€—å·ï¼‰
            const text = inputEl.value;
            words = text.split(/[\s,\n]+/).filter(w => w.trim() !== '');
            
            // é‡ç½®çŠ¶æ€
            stop();
            currentIndex = 0;
            updateUI();
            renderSheet();
            requestFit();
        }

        // è®¾ç½®æ¨¡å¼ (1é/2é)
        function setMode(times, el) {
            repeatTimes = times;
            document.querySelectorAll('.capsule-group')[0].querySelectorAll('.capsule').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        // è®¾ç½®é—´éš”
        function setSpeed(ms, el) {
            intervalTime = ms;
            document.querySelectorAll('.capsule-group')[1].querySelectorAll('.capsule').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        // --- æ ¸å¿ƒæ’­æ”¾é€»è¾‘ ---
        function togglePlay() {
            if (isPlaying) stop();
            else playSequence();
        }

        function stop() {
            isPlaying = false;
            clearTimeout(timeoutId);
            synth.cancel();
            updateUI();
            statusEl.innerText = "å·²æš‚åœ";
        }

        function playSequence() {
            if (words.length === 0) return;
            isPlaying = true;
            updateUI();
            statusEl.innerText = "æ­£åœ¨å¬å†™...";
            speakCurrentWord();
        }

        function speakCurrentWord() {
            if (!isPlaying) return;
            if (currentIndex >= words.length) {
                stop();
                statusEl.innerText = "å¬å†™å®Œæˆ ğŸ‰";
                displayEl.innerText = "å®Œæˆ";
                return;
            }

            const word = words[currentIndex];
            displayEl.innerText = word;
            progressEl.innerText = `${currentIndex + 1} / ${words.length}`;

            // æœ—è¯»é€»è¾‘ï¼šç¬¬Nä¸ªè¯...è¯è¯­...è¯è¯­
            let textToRead = "";
            if (repeatTimes >= 1) textToRead += `ç¬¬${currentIndex + 1}ä¸ªè¯ï¼š${word}ã€‚`;
            if (repeatTimes >= 2) textToRead += `${word}ã€‚`;
            if (repeatTimes >= 3) textToRead += `${word}ã€‚`;

            const utter = new SpeechSynthesisUtterance(textToRead);
            utter.rate = 0.9; // è¯­é€Ÿç¨æ…¢
            utter.pitch = 1.1; // è¯­è°ƒç¨é«˜ï¼Œåƒè€å¸ˆ
            utter.lang = 'zh-CN';

            utter.onend = () => {
                if (isPlaying) {
                    statusEl.innerText = "ç­‰å¾…ä¹¦å†™...";
                    // è¯»å®Œåç­‰å¾…
                    timeoutId = setTimeout(() => {
                        currentIndex++;
                        speakCurrentWord();
                    }, intervalTime);
                }
            };

            synth.speak(utter);
        }

        function nextWord() {
            if (currentIndex < words.length - 1) {
                currentIndex++;
                if (isPlaying) {
                    synth.cancel();
                    clearTimeout(timeoutId);
                    speakCurrentWord();
                } else {
                    updateUI();
                }
            }
        }

        function prevWord() {
            if (currentIndex > 0) {
                currentIndex--;
                if (isPlaying) {
                    synth.cancel();
                    clearTimeout(timeoutId);
                    speakCurrentWord();
                } else {
                    updateUI();
                }
            }
        }

        function updateUI() {
            const iconPlay = document.getElementById('iconPlay');
            const iconPause = document.getElementById('iconPause');
            
            if (isPlaying) {
                iconPlay.style.display = 'none';
                iconPause.style.display = 'block';
            } else {
                iconPlay.style.display = 'block';
                iconPause.style.display = 'none';
            }
            
            if (words.length > 0) {
                displayEl.innerText = words[currentIndex];
                progressEl.innerText = `${currentIndex + 1} / ${words.length}`;
            } else {
                displayEl.innerText = "...";
                progressEl.innerText = "0 / 0";
            }
        }

        // --- æ¸²æŸ“æ‰“å°çº¸ ---
        function renderSheet() {
            const cols = 14;
            const rows = 9;
            const headerRows = 1; // é¢„ç•™ä¸€è¡Œå†™æ—¥æœŸ
            const cellsPerPage = cols * rows;
            const startCell = cols * headerRows;

            function newPage() {
                return new Array(cellsPerPage).fill(null);
            }

            const pages = [newPage()];
            let pageIndex = 0;
            let cursor = startCell;

            function ensureSpace(requiredCells) {
                const col = cursor % cols;
                if (col + requiredCells > cols) cursor += (cols - col);
                if (cursor + requiredCells > cellsPerPage) {
                    pages.push(newPage());
                    pageIndex += 1;
                    cursor = startCell;
                }
            }

            words.forEach((word, index) => {
                const chars = word.split('');
                const required = 1 + chars.length + 1; // åºå·æ ¼ + å­—æ ¼ + é—´éš” 1 æ ¼
                ensureSpace(required);

                pages[pageIndex][cursor] = { type: 'num', value: index + 1 };
                cursor += 1;
                for (let i = 0; i < chars.length; i++) {
                    pages[pageIndex][cursor] = { type: 'char' };
                    cursor += 1;
                }
                pages[pageIndex][cursor] = { type: 'spacer' };
                cursor += 1;
            });

            const sheetsHtml = pages.map((page) => {
                let gridHtml = '';
                for (let i = 0; i < cellsPerPage; i++) {
                    const cell = page[i];
                    gridHtml += `<div class="tian-cell"></div>`;
                }
                return `
                    <section class="sheet-preview">
                        <div class="tian-grid-wrap">
                            <div class="tian-grid">${gridHtml}</div>
                        </div>
                    </section>
                `;
            });

            sheetEl.innerHTML = sheetsHtml.join('');
            requestFit();
        }
    </script>
</body>
</html>
