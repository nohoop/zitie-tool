<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YoBox å­—å¸–å·¥åŠ</title>
    
    <style>
        :root {
            --app-bg: #f2f2f7;
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            --accent: #007aff; 
            --text-main: #1d1d1f;
            --text-sec: #86868b;
            --border: #d2d2d7;
            --grid-main: #2c8a4c;
            --grid-sub: #a1dcb6;
            --char-color: #333;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "SF Pro Text", sans-serif;
            background: var(--app-bg); color: var(--text-main);
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- ä¾§è¾¹æ  (å“åº”å¼æŠ½å±‰) --- */
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            z-index: 200; /* é«˜å±‚çº§ */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .brand-area { padding: 16px 16px 8px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .back-link {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 13px; color: var(--accent); font-weight: 500;
            text-decoration: none; margin-bottom: 12px; opacity: 0.9;
        }

        .brand-title { font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 10px; }
        .tag { background: linear-gradient(135deg, #007aff, #0051a8); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }

        .search-box { position: relative; margin-bottom: 5px; }
        .search-input {
            width: 100%; padding: 8px 10px 8px 30px;
            border-radius: 10px; border: 1px solid #d2d2d7;
            background: rgba(118, 118, 128, 0.12);
            font-size: 13px; outline: none; transition: 0.2s;
        }
        .search-input:focus { background: white; border-color: var(--accent); }
        .search-icon { position: absolute; left: 8px; top: 8px; opacity: 0.5; width: 14px; height: 14px; }

        .course-list { flex: 1; overflow-y: auto; padding: 0 10px 10px; -webkit-overflow-scrolling: touch; }
        
        .group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 8px; margin-top: 5px;
            font-size: 13px; font-weight: 600; color: var(--text-sec);
            cursor: pointer; border-radius: 8px;
        }
        .group-header:hover { background: rgba(0,0,0,0.03); color: var(--text-main); }
        .group-arrow { width: 10px; height: 10px; opacity: 0.5; transition: transform 0.2s; }
        .group-header.active .group-arrow { transform: rotate(90deg); }

        .group-body { height: 0; overflow: hidden; opacity: 0; transition: all 0.3s ease; }
        .group-body.expanded { height: auto; opacity: 1; padding-bottom: 5px; }

        .course-item {
            padding: 10px 10px 10px 22px;
            font-size: 14px; color: var(--text-main);
            border-radius: 8px; cursor: pointer; margin-bottom: 2px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .course-item:active { background: rgba(0,0,0,0.05); }
        .course-item.active { background: var(--accent); color: white; font-weight: 500; }
        .course-item.hidden { display: none; }
        .count-badge { font-size: 10px; opacity: 0.6; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
        .course-item.active .count-badge { background: rgba(255,255,255,0.2); opacity: 0.9; }

        .settings-panel {
            padding: 16px; background: white;
            border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 12px;
            /* é€‚é… iPhone åº•éƒ¨å®‰å…¨åŒº */
            padding-bottom: env(safe-area-inset-bottom, 20px); 
        }
        .control-row { display: flex; flex-direction: column; gap: 4px; }
        .lbl { font-size: 11px; font-weight: 600; color: var(--text-sec); text-transform: uppercase; }
        
        .batch-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .batch-btn { font-size: 12px; padding: 6px 12px; border-radius: 14px; border: 1px solid #d2d2d7; background: #f5f5f7; color: #333; cursor: pointer; }
        .batch-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid #e5e5ea; border-radius: 8px;
            font-size: 14px; background: #f5f5f7; box-sizing: border-box; outline: none;
            font-family: inherit; -webkit-appearance: none; /* ç§»é™¤iOSé»˜è®¤æ ·å¼ */
        }
        textarea { height: 60px; resize: none; }

        /* --- ä¸»ç•Œé¢ --- */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; transition: opacity 0.3s; }
        
        .toolbar {
            height: 50px; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; position: sticky; top: 0; z-index: 10;
        }
        
        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .menu-btn {
            display: none; /* é»˜è®¤éšè— */
            background: none; border: none; padding: 8px; margin-left: -8px; cursor: pointer; color: var(--accent);
        }

        .doc-name { font-weight: 600; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        .btn-print {
            background: var(--accent); color: white; border: none;
            padding: 6px 14px; border-radius: 16px; font-size: 13px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; gap: 4px;
        }

        /* èˆå°ä¸çº¸å¼  */
        .stage { 
            flex: 1; overflow-y: auto; padding: 20px; 
            display: flex; justify-content: center; background: var(--app-bg);
            -webkit-overflow-scrolling: touch;
        }
        
        .sheet {
            width: 210mm; min-height: 297mm; background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 15mm 12mm; box-sizing: border-box;
            display: flex; flex-direction: column;
            transform-origin: top center; /* ç¼©æ”¾åŸç‚¹ */
        }

        /* å†…éƒ¨æ ¼çº¿ */
        .sheet-header { height: 14mm; border-bottom: 2px solid var(--grid-main); display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 4px; margin-bottom: 4mm; font-family: "KaiTi", serif; font-size: 15px; color: #333; }
        .underline { border-bottom: 1px solid #333; min-width: 40px; display: inline-block; text-align: center; }
        .char-block { margin-bottom: 4mm; break-inside: avoid; }
        .row { display: flex; height: 17mm; border-left: 1px solid var(--grid-main); }
        .cell { width: 13mm; height: 100%; position: relative; border-right: 1px solid var(--grid-main); border-bottom: 1px solid var(--grid-main); border-top: 1px solid var(--grid-main); display: flex; flex-direction: column; }
        .pinyin { height: 4.5mm; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #666; font-family: Arial; border-bottom: 1px dashed var(--grid-sub); }
        .hanzi { flex: 1; position: relative; }
        .grid-lines { position: absolute; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events: none; }
        .char-svg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; padding: 7%; box-sizing: border-box; }
        .char-placeholder { min-height: 38mm; display: flex; align-items: center; justify-content: center; color: var(--text-sec); font-size: 13px; }

        /* é®ç½©å±‚ */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 150;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        #toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 12px; font-size: 14px; font-weight: 500;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999;
        }

        /* ğŸ“± ç§»åŠ¨ç«¯é€‚é… (Media Query) */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; top: 0; left: 0; bottom: 0;
                transform: translateX(-100%); /* é»˜è®¤éšè—åœ¨å·¦ä¾§ */
                box-shadow: 2px 0 20px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(0); } /* æ»‘å‡º */

            .menu-btn { display: block; } /* æ˜¾ç¤ºèœå•æŒ‰é’® */
            .main { width: 100%; }
            
            .stage { padding: 20px 10px; display: block; } /* å…è®¸ç¼©å° */
            
            /* ç§»åŠ¨ç«¯é¢„è§ˆè‡ªåŠ¨ç¼©æ”¾ (æ ¸å¿ƒæŠ€å·§) */
            /* æˆ‘ä»¬ä¸èƒ½æ”¹å˜ sheet çš„ç‰©ç†å°ºå¯¸(210mm)ï¼Œå¦åˆ™æ‰“å°å°±å˜å°äº† */
            /* è€Œæ˜¯ç”¨ transform: scale è§†è§‰ç¼©å°å®ƒ */
            /* å…·ä½“çš„ scale å€¼ç”± JS åŠ¨æ€è®¡ç®— */
        }

        @media print {
            /* å…³é”®ï¼šä¸è¦åœ¨ @page é‡Œç•™è¾¹è·ï¼Œå¦åˆ™ 210Ã—297mm çš„ .sheet ä¼šæº¢å‡ºå¯æ‰“å°åŒºåŸŸï¼Œå¯¼è‡´æ¯å¼ çº¸è¢«æ‹†æˆâ€œå†…å®¹é¡µ+ç©ºç™½é¡µâ€ */
            @page { size: A4 portrait; margin: 0; }
            html, body { width: 210mm; margin: 0; padding: 0; }
            body { display: block; height: auto; overflow: visible; background: #fff; }
            .sidebar, .toolbar, #toast, .overlay { display: none !important; }
            .main, .stage { padding: 0; margin: 0; background: white; height: auto; display: block; }
            .sheet { 
                box-shadow: none; margin: 0; margin-bottom: 0 !important;
                width: 210mm; height: 297mm; min-height: 0;
                box-sizing: border-box;
                page-break-inside: avoid; break-inside: avoid-page;
                break-after: page; page-break-after: always;
                transform: none !important; /* æ‰“å°æ—¶å¿…é¡»è¿˜åŸæ¯”ä¾‹ */
            }
            .sheet:last-child { break-after: auto; page-break-after: auto; }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.2/dist/index.min.js"></script>
</head>
<body>

    <div id="toast">å‡†å¤‡å°±ç»ª</div>
    <div class="overlay" id="overlay" onclick="toggleSidebar(false)"></div>

    <aside class="sidebar" id="sidebar">
        <div class="brand-area">
            <a href="../" class="back-link">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg>
                è¿”å› YoBox å¤§å…
            </a>
            
            <div class="brand-title">âœï¸ å­—å¸–å·¥åŠ <span class="tag">V16.0</span></div>
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" class="search-input" placeholder="æœç´¢è¯¾ç¨‹..." oninput="filterCourses(this.value)">
            </div>
        </div>
        
        <div class="course-list" id="menuRoot"></div>

        <div class="settings-panel">
            <div class="control-row" id="batchControlRow" style="display:none;">
                <span class="lbl">ğŸ“š å†…å®¹åˆ†å·</span>
                <div class="batch-container" id="batchContainer"></div>
            </div>

            <div class="control-row">
                <span class="lbl">ç”Ÿå­—å†…å®¹</span>
                <textarea id="inputStr">å¤©åœ°äººé‡‘æœ¨æ°´ç«åœŸ</textarea>
            </div>
            
            <div class="control-row">
                <span class="lbl">è®¾ç½®</span>
                <div style="display:flex; gap:8px;">
                    <select id="gridType" onchange="render()" style="flex:1">
                        <option value="tian">ç”°å­—æ ¼</option>
                        <option value="mi">ç±³å­—æ ¼</option>
                    </select>
                    <select id="density" onchange="render()" style="flex:1">
                        <option value="6">6å­—/é¡µ</option>
                        <option value="7">7å­—/é¡µ</option>
                    </select>
                </div>
                <div style="display:flex; gap:8px; margin-top:4px;">
                    <select id="mode" onchange="render()" style="flex:1">
                        <option value="progressive">æ¸éš</option>
                        <option value="trace">æçº¢</option>
                    </select>
                    <select id="colorTheme" onchange="updateTheme()" style="flex:1">
                        <option value="green">æŠ¤çœ¼ç»¿</option>
                        <option value="red">ä¹¦æ³•çº¢</option>
                    </select>
                </div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="toolbar">
            <!-- ç§»åŠ¨ç«¯æ±‰å ¡èœå• -->
            <button class="menu-btn" onclick="toggleSidebar(true)">
                <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>

            <div class="doc-name" id="docTitle">æ¼”ç¤ºç»ƒä¹ </div>
            <button class="btn-print" onclick="window.print()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                <span style="margin-left:4px">æ‰“å°</span>
            </button>
        </div>
        <div class="stage">
            <div id="previewArea"></div>
        </div>
    </main>

    <script>
        // æ•°æ®åº“ (ä¿æŒåŸæ ·ï¼Œçœç•¥éƒ¨åˆ†ä»¥èŠ‚çœé•¿åº¦ï¼ŒåŠŸèƒ½ä¸å˜)
        const DB = [
            { grade: "ğŸŸ¢ ä¸€å¹´çº§", lessons: [ { t: "ä¸Šå†Œå…¨é›†", c: "ä¸€äºŒä¸‰ä¸Šå£ç›®è€³æ‰‹æ—¥ç”°ç¦¾ç«è™«äº‘å±±å…«åäº†å­äººå¤§æœˆå„¿å¤´é‡Œå¯ä¸œè¥¿å¤©å››æ˜¯å¥³å¼€æ°´å»æ¥ä¸å°å°‘ç‰›æœé¸Ÿæ—©ä¹¦åˆ€å°ºæœ¬æœ¨æ—åœŸåŠ›å¿ƒä¸­äº”ç«‹æ­£åœ¨åæˆ‘å¥½é•¿æ¯”å·´æŠŠä¸‹ä¸ªé›¨ä»¬é—®æœ‰åŠä»ä½ æ‰æ˜åŒå­¦è‡ªå·±è¡£ç™½çš„åˆå’Œç«¹ç‰™é©¬ç”¨å‡ åªçŸ³å¤šå‡ºè§å¯¹å¦ˆå…¨å›" }, { t: "ä¸‹å†Œå…¨é›†", c: "æ˜¥é£å†¬é›ªèŠ±é£å…¥å§“ä»€ä¹ˆåŒå›½ç‹æ–¹é’æ¸…æ°”æ™´æƒ…è¯·ç”Ÿå­—å·¦å³çº¢æ—¶åŠ¨ä¸‡åƒå«ä¸»æ±Ÿä½æ²¡ä»¥ä¼šèµ°åŒ—äº¬é—¨å¹¿è¿‡å„æ ·ä¼™ä¼´è¿™å¤ªé˜³æ ¡é‡‘ç§‹å› ä¸ºä¹Ÿä»–åœ°æ²³è¯´å¬å“¥å•å±…æ‹›å‘¼å¿«ä¹ç©å¾ˆå½“éŸ³è®²è¡Œè®¸æ€åºŠå‰å…‰ä½æ•…ä¹¡è‰²å¤–çœ‹çˆ¸æ™šç¬‘å†åˆèŠ‚å¶ç±³çœŸåˆ†è±†é‚£ç€åˆ°é«˜å…´åƒæˆé—´è¿·é€ è¿æ± æ¬¢ç½‘å¤å‡‰ç»†å¤•æè¯­é¦™æ‰“æ‹è·‘è¶³å£°èº«ä½“ä¹‹ç›¸è¿‘ä¹ è¿œç‰ä¹‰é¦–é‡‡æ— æ ‘çˆ±å°–è§’äº®æœºå°æ”¾é±¼æœµç¾ç›´å‘€è¾¹å‘¢å—åŠ æ–‡æ¬¡æ‰¾å¹³åŠè®©åŒ…é’Ÿå…ƒæ´—å…±å·²ç»åè¦è¿ç™¾è¿˜èˆŒç‚¹å—éå¸¸å¾€ç“œè¿›ç©ºåŒ»åˆ«å¹²å¥‡ä¸ƒæ˜Ÿå“æ€•è·Ÿå®¶ç¾Šè±¡éƒ½æ‰æ¡çˆ¬å§æ‚¨è‰æˆ¿" } ] },
            { grade: "ğŸ”µ äºŒå¹´çº§", lessons: [ { t: "ä¸Šå†Œå…¨é›†", c: "ä¸¤å“ªå®½é¡¶çœ¼ç›è‚šçš®å­©è·³å˜æç‰‡å‚æµ·æ´‹ä½œåç»™å¸¦æ³•å¦‚è„šå®ƒå¨ƒå¥¹æ¯›æ›´çŸ¥è¯†å°æ¡¥æµæ°´äººå®¶ç¾¤é˜Ÿæ——é“œå·é¢†å·¾æ¨å£®æ¡æ«æ¾æŸæ£‰æ‰åŒ–æ¡‚æ­Œå†™ä¸›æ·±å…­ç†ŠçŒ«æœ‹å‹å­£å¹è‚¥å†œå¿™å½’çˆ±è¾›è‹¦å¹´ç™¾èŠ±æå´éƒ‘æ¢é™ˆèµµé’±å­™å‘¨ç‹å®˜å¼ å¤è¯—æ‘ç«¥ç¢§å¦†ç»¿ä¸å‰ª" }, { t: "ä¸‹å†Œå…¨é›†", c: "å¤è¯—æ‘ç«¥ç¢§å¦†ç»¿ä¸å‰ªå†²å¯»å§‘å¨˜åæŸ³è¡æ¡ƒæé²œé‚®é€’å‘˜åŸå”å±€å †ç¤¼é‚“æ¤æ ¼å¼•æ³¨æ»¡ä¼‘æ¯ç«™è´´ç”»æ¯çˆ±å¯¹å¶åœ†ç‰‡æ²™æµ·æ»©å†›èˆ°å¸†å·å·¾é“œé¢†é˜Ÿæ——æ¨å£®æ¡æ«æ¾æŸæ£‰æ‰åŒ–æ¡‚æ­Œå†™ä¸›æ·±å…­ç†ŠçŒ«æœ‹å‹å­£å¹è‚¥å†œå¿™å½’çˆ±è¾›è‹¦" } ] },
            { grade: "ğŸ‘¶ æ‰©å±•ç»ƒä¹ ", lessons: [ { t: "æ•°å­— 0-10", c: "é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å" }, { t: "å¿…èƒŒå¤è¯—", c: "é¹…é¹…é¹…æ›²é¡¹å‘å¤©æ­Œç™½æ¯›æµ®ç»¿æ°´çº¢æŒæ‹¨æ¸…æ³¢åºŠå‰æ˜æœˆå…‰ç–‘æ˜¯åœ°ä¸Šéœœ" } ] }
        ];

        // æ ¸å¿ƒé€»è¾‘ï¼šå­—å½¢æ•°æ®åŠ è½½ï¼ˆæ›´å¿«ã€æ›´ç¨³ï¼šç¼–ç  + è¶…æ—¶ + é‡è¯• + å¹¶å‘é™åˆ¶ï¼‰
        const charCache = new Map();
        const CHAR_DATA_SOURCES = [
            (c) => `https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${c}.json`,
            (c) => `https://npm.elemecdn.com/hanzi-writer-data@2.0/${c}.json`,
            (c) => `https://unpkg.com/hanzi-writer-data@2.0/${c}.json`,
        ];

        async function fetchJsonWithTimeout(url, { timeoutMs, cacheMode }) {
            const fetchOpts = {};
            if (cacheMode) fetchOpts.cache = cacheMode;

            let timerId = 0;
            let controller = null;
            const canAbort = typeof AbortController !== 'undefined';
            if (canAbort) {
                controller = new AbortController();
                fetchOpts.signal = controller.signal;
            }

            const timeoutPromise = new Promise((_, reject) => {
                timerId = window.setTimeout(() => {
                    try { controller?.abort(); } catch { /* ignore */ }
                    reject(new Error('timeout'));
                }, timeoutMs);
            });

            try {
                const fetchPromise = fetch(url, fetchOpts).then(async (res) => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                });
                return await Promise.race([fetchPromise, timeoutPromise]);
            } finally {
                window.clearTimeout(timerId);
            }
        }

        async function fetchCharDataFromCDN(char) {
            const encoded = encodeURIComponent(char);
            let lastError;
            for (const mk of CHAR_DATA_SOURCES) {
                const baseUrl = mk(encoded);
                try {
                    return await fetchJsonWithTimeout(baseUrl, { timeoutMs: 9000, cacheMode: 'force-cache' });
                } catch (e1) {
                    lastError = e1;
                    try {
                        return await fetchJsonWithTimeout(baseUrl, { timeoutMs: 9000, cacheMode: 'no-store' });
                    } catch (e2) {
                        lastError = e2;
                    }
                }
            }
            throw lastError || new Error('Failed to load character data');
        }

        async function loadCharData(char) {
            if (charCache.has(char)) return charCache.get(char);
            const data = await fetchCharDataFromCDN(char);
            charCache.set(char, data);
            return data;
        }

        async function mapWithConcurrency(items, limit, fn) {
            const results = new Array(items.length);
            let cursor = 0;
            const workers = new Array(Math.min(limit, items.length)).fill(0).map(async () => {
                while (cursor < items.length) {
                    const idx = cursor;
                    cursor += 1;
                    results[idx] = await fn(items[idx], idx);
                }
            });
            await Promise.all(workers);
            return results;
        }

        const { pinyin } = window.pinyinPro || { pinyin: (c) => c };
        const menuRoot = document.getElementById('menuRoot');
        const inputStr = document.getElementById('inputStr');
        const preview = document.getElementById('previewArea');
        const batchRow = document.getElementById('batchControlRow');
        const batchContainer = document.getElementById('batchContainer');
        const BATCH_SIZE = 12;
        const COLS = 13;
        let timer;
        let renderToken = 0;

        function initMenu() {
            menuRoot.innerHTML = '';
            DB.forEach((group, idx) => {
                const header = document.createElement('div');
                header.className = `group-header ${idx===0?'active':''}`;
                header.innerHTML = `<span>${group.grade}</span><svg class="group-arrow" viewBox="0 0 1024 1024" width="10"><path d="M340.992 822.464l369.856-310.272-369.856-310.464z" fill="currentColor"/></svg>`;
                const body = document.createElement('div');
                body.className = `group-body ${idx===0?'expanded':''}`;
                
                group.lessons.forEach(l => {
                    const item = document.createElement('div');
                    item.className = 'course-item';
                    item.setAttribute('data-k', l.t+l.c);
                    item.innerHTML = `<span>${l.t}</span><span class="count-badge">${l.c.length}å­—</span>`;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        if(window.innerWidth <= 768) toggleSidebar(false); // æ‰‹æœºç«¯é€‰ä¸­åè‡ªåŠ¨æ”¶èµ·èœå•
                        document.querySelectorAll('.course-item').forEach(x=>x.classList.remove('active'));
                        item.classList.add('active');
                        handleSelection(l.t, l.c);
                    };
                    body.appendChild(item);
                });
                header.onclick = () => { header.classList.toggle('active'); body.classList.toggle('expanded'); };
                menuRoot.appendChild(header); menuRoot.appendChild(body);
            });
            render();
            autoScale(); // åˆå§‹åŒ–ç¼©æ”¾
        }

        function handleSelection(t, c) {
            batchContainer.innerHTML = '';
            if (c.length <= 15) {
                batchRow.style.display = 'none'; inputStr.value = c;
                document.getElementById('docTitle').innerText = t; render(); return;
            }
            batchRow.style.display = 'flex';
            const batches = Math.ceil(c.length / BATCH_SIZE);
            for (let i = 0; i < batches; i++) {
                const btn = document.createElement('div'); btn.className = 'batch-btn';
                btn.innerText = `${i+1}å·`;
                btn.onclick = () => {
                    document.querySelectorAll('.batch-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    inputStr.value = c.substring(i*BATCH_SIZE, (i+1)*BATCH_SIZE);
                    document.getElementById('docTitle').innerText = `${t} (${i+1})`; render();
                };
                batchContainer.appendChild(btn);
            }
            batchContainer.firstChild.click();
        }

        async function render() {
            const token = ++renderToken;
            const str = inputStr.value.replace(/[^\u4e00-\u9fa5]/g,'');
            const chars = Array.from(new Set(str.split('')));
            const mode = document.getElementById('mode').value;
            const type = document.getElementById('gridType').value;
            const density = parseInt(document.getElementById('density').value);

            preview.innerHTML = '';
            const pages = Math.ceil(chars.length / density);
            const placeholdersByChar = new Map();
            for(let p=0; p<pages; p++) {
                const sheet = document.createElement('div'); sheet.className = 'sheet';
                sheet.innerHTML = `<div class="sheet-header"><div>${document.getElementById('docTitle').innerText}</div><div>æ—¥æœŸ:___ è¯„åˆ†:___</div></div><div class="sheet-content"></div>`;
                const content = sheet.querySelector('.sheet-content');
                const slice = chars.slice(p*density, (p+1)*density);

                slice.forEach((char) => {
                    const ph = document.createElement('div');
                    ph.className = 'char-placeholder';
                    ph.innerText = 'åŠ è½½ä¸­â€¦';
                    content.appendChild(ph);
                    if (!placeholdersByChar.has(char)) placeholdersByChar.set(char, []);
                    placeholdersByChar.get(char).push({ ph, content });
                });
                preview.appendChild(sheet);
            }

            // é¢„å–ï¼šé™åˆ¶å¹¶å‘ï¼Œé¿å…ç½‘ç»œæ‹¥å¡å¯¼è‡´â€œåŠ è½½å¤±è´¥â€
            const uniqueChars = Array.from(placeholdersByChar.keys());
            await mapWithConcurrency(uniqueChars, 4, async (char) => {
                try {
                    const data = await loadCharData(char);
                    if (token !== renderToken) return;
                    const list = placeholdersByChar.get(char) || [];
                    list.forEach(({ ph, content }) => {
                        const block = createBlock(char, data, mode, type);
                        if (ph.parentNode === content) content.replaceChild(block, ph);
                    });
                } catch {
                    if (token !== renderToken) return;
                    const list = placeholdersByChar.get(char) || [];
                    list.forEach(({ ph }) => { if (ph) ph.innerText = 'åŠ è½½å¤±è´¥'; });
                }
            });
            autoScale(); // æ¸²æŸ“åå†æ¬¡ç¼©æ”¾
        }

        function createBlock(char, data, mode, type) {
            const blk = document.createElement('div'); blk.className = 'char-block';
            const r1 = document.createElement('div'); r1.className = 'row';
            for(let i=0; i<COLS; i++) {
                let m='empty', s=-1; if(i===0)m='black'; else if(i<=data.strokes.length){m='step';s=i-1} else m='trace';
                r1.appendChild(cell(data.strokes, pinyin(char), m, s, type, i===0));
            }
            blk.appendChild(r1);
            const r2 = document.createElement('div'); r2.className = 'row'; r2.style.borderTop='none';
            for(let i=0; i<COLS; i++) {
                let m=(i===0)?'black':(mode==='progressive'?(i<4?'trace':(i<8?'trace':'empty')):mode);
                let op=(m==='trace' && mode==='progressive' && i>=4)?0.3:1;
                const c = cell(data.strokes, '', m, -1, type, false);
                if(m==='trace') c.querySelector('path').style.opacity=op;
                r2.appendChild(c);
            }
            blk.appendChild(r2);
            return blk;
        }

        function cell(sts, py, m, s, type, cnt) {
            const d = document.createElement('div'); d.className = 'cell';
            const pd = document.createElement('div'); pd.className = 'pinyin'; pd.innerText = py;
            if(cnt) { const b=document.createElement('span'); b.style.cssText="position:absolute;right:2px;top:1px;font-size:8px;color:#999"; b.innerText=sts.length; pd.appendChild(b); }
            d.appendChild(pd);
            const hd = document.createElement('div'); hd.className = 'hanzi';
            let l = `<line x1="0" y1="50%" x2="100%" y2="50%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/><line x1="50%" y1="0" x2="50%" y2="100%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/>`;
            if(type==='mi') l += `<line x1="0" y1="0" x2="100%" y2="100%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/><line x1="100%" y1="0" x2="0" y2="100%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/>`;
            hd.innerHTML = `<svg class="grid-lines" width="100%" height="100%">${l}</svg>`;
            if(sts && m!=='empty') {
                let p = ''; sts.forEach((pt, i) => {
                    let c = 'var(--char-color)'; if(m==='trace')c='#d1d1d6'; else if(m==='step'){if(i<s)c='#d1d1d6';else if(i===s)c='#ff3b30';else return;}
                    p += `<path d="${pt}" fill="${c}"/>`;
                });
                hd.insertAdjacentHTML('beforeend', `<svg class="char-svg" viewBox="0 0 1024 1024"><g transform="scale(1, -1) translate(0, -900)">${p}</g></svg>`);
            }
            d.appendChild(hd); return d;
        }

        // --- ç§»åŠ¨ç«¯äº¤äº’é€»è¾‘ ---
        function toggleSidebar(show) {
            const sb = document.getElementById('sidebar');
            const ol = document.getElementById('overlay');
            if(show) { sb.classList.add('open'); ol.classList.add('active'); }
            else { sb.classList.remove('open'); ol.classList.remove('active'); }
        }

        // æ ¸å¿ƒï¼šè‡ªåŠ¨ç¼©æ”¾é¢„è§ˆå›¾
        function autoScale() {
            if(window.innerWidth > 768) { 
                document.querySelectorAll('.sheet').forEach(s => { s.style.transform = 'none'; s.style.marginBottom = '0'; });
                return; 
            }
            // æ‰‹æœºç«¯ï¼šè®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const stageWidth = document.querySelector('.stage').offsetWidth - 40; // å‡å»padding
            const paperWidth = 210 * 3.78; // A4 mm è½¬ px (å¤§æ¦‚ 794px)
            const scale = stageWidth / paperWidth;
            
            document.querySelectorAll('.sheet').forEach(s => {
                s.style.transform = `scale(${scale})`;
                s.style.marginBottom = `-${(1-scale)*297*3.78}px`; // ä¿®æ­£ç¼©æ”¾åçš„ç©ºç™½
            });
        }

        function filterCourses(val) {
            val = val.trim().toLowerCase();
            document.querySelectorAll('.course-item').forEach(i => {
                const match = i.getAttribute('data-k').toLowerCase().includes(val);
                i.classList.toggle('hidden', !match && val!=='');
                if(match && val!=='') { i.parentElement.classList.add('expanded'); i.parentElement.previousSibling.classList.add('active'); }
            });
        }

        function updateTheme() {
            const t=document.getElementById('colorTheme').value; const r=document.documentElement.style;
            if(t==='green'){r.setProperty('--grid-main','#2c8a4c');r.setProperty('--grid-sub','#a1dcb6');}
            else{r.setProperty('--grid-main','#d93a3a');r.setProperty('--grid-sub','#ffb3b0');}
            render();
        }

        inputStr.addEventListener('input', ()=>{ clearTimeout(timer); batchRow.style.display='none'; timer=setTimeout(render,500); });
        window.addEventListener('resize', autoScale); // å±å¹•æ—‹è½¬æ—¶é‡æ–°è®¡ç®—
        window.onload = initMenu;
    </script>
</body>
</html>
