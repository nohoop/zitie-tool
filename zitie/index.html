<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YoBox å­—å¸–å·¥åŠ</title>
    
    <style>
        :root {
            /* macOS é£æ ¼ */
            --app-bg: #f5f5f7;
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            --accent: #007aff; 
            --text-main: #1d1d1f;
            --text-sec: #86868b;
            --border: #d2d2d7;
            --grid-main: #2c8a4c;
            --grid-sub: #a1dcb6;
            --char-color: #333;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "SF Pro Text", sans-serif;
            background: var(--app-bg); color: var(--text-main);
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            z-index: 100; user-select: none;
        }

        .brand-area { padding: 16px 16px 8px; }
        
        /* è¿”å›é¦–é¡µæŒ‰é’® */
        .back-link {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 13px; color: var(--accent); font-weight: 500;
            text-decoration: none; margin-bottom: 12px; opacity: 0.9;
            transition: 0.2s;
        }
        .back-link:hover { opacity: 1; transform: translateX(-2px); }

        .brand-title { font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 10px; }
        .tag { background: linear-gradient(135deg, #007aff, #0051a8); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }

        /* æœç´¢æ¡† */
        .search-box { position: relative; margin-bottom: 5px; }
        .search-input {
            width: 100%; padding: 7px 10px 7px 28px;
            border-radius: 8px; border: 1px solid #d2d2d7;
            background: rgba(118, 118, 128, 0.12);
            font-size: 13px; outline: none; transition: 0.2s;
        }
        .search-input:focus { background: white; border-color: var(--accent); }
        .search-icon { position: absolute; left: 8px; top: 8px; opacity: 0.5; width: 13px; height: 13px; }

        /* è¯¾ç¨‹åˆ—è¡¨ */
        .course-list { flex: 1; overflow-y: auto; padding: 0 10px 10px; }
        
        .group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 8px; margin-top: 5px;
            font-size: 12px; font-weight: 600; color: var(--text-sec);
            cursor: pointer; border-radius: 6px; transition: 0.2s;
        }
        .group-header:hover { background: rgba(0,0,0,0.03); color: var(--text-main); }
        .group-arrow { width: 10px; height: 10px; opacity: 0.5; transition: transform 0.2s; }
        .group-header.active .group-arrow { transform: rotate(90deg); }

        .group-body { height: 0; overflow: hidden; opacity: 0; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .group-body.expanded { height: auto; opacity: 1; padding-bottom: 5px; }

        .course-item {
            padding: 8px 10px 8px 22px;
            font-size: 13px; color: var(--text-main);
            border-radius: 6px; cursor: pointer; margin-bottom: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .course-item:hover { background: rgba(0,0,0,0.05); }
        .course-item.active { background: var(--accent); color: white; font-weight: 500; }
        .course-item.hidden { display: none; }
        .count-badge { font-size: 10px; opacity: 0.6; background: rgba(0,0,0,0.05); padding: 1px 5px; border-radius: 4px; }
        .course-item.active .count-badge { background: rgba(255,255,255,0.2); opacity: 0.9; }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            padding: 16px; background: white;
            border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 12px;
        }
        .control-row { display: flex; flex-direction: column; gap: 4px; }
        .lbl { font-size: 11px; font-weight: 600; color: var(--text-sec); text-transform: uppercase; }
        
        /* æ™ºèƒ½åˆ†å·æŒ‰é’® */
        .batch-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .batch-btn { font-size: 12px; padding: 4px 10px; border-radius: 12px; border: 1px solid #d2d2d7; background: #f5f5f7; color: #333; cursor: pointer; transition: 0.2s; }
        .batch-btn:hover { background: #e5e5ea; }
        .batch-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        input, select, textarea {
            width: 100%; padding: 8px; border: 1px solid #e5e5ea; border-radius: 6px;
            font-size: 13px; background: #f5f5f7; box-sizing: border-box; outline: none;
            font-family: inherit; transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { background: white; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }
        textarea { height: 50px; resize: none; }

        /* --- ä¸»ç•Œé¢ --- */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        .toolbar {
            height: 50px; background: rgba(255,255,255,0.6);
            backdrop-filter: blur(20px); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .doc-name { font-weight: 600; font-size: 15px; }

        .btn-print {
            background: var(--accent); color: white; border: none;
            padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn-print:hover { background: #0062cc; box-shadow: 0 2px 8px rgba(0,122,255,0.25); }

        .stage { flex: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; background: var(--app-bg); }
        
        .sheet {
            width: 210mm; min-height: 297mm; background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            padding: 15mm 12mm; box-sizing: border-box;
            display: flex; flex-direction: column;
            margin-bottom: 40px;
        }

        .sheet-header { height: 14mm; border-bottom: 2px solid var(--grid-main); display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 4px; margin-bottom: 4mm; font-family: "KaiTi", serif; font-size: 15px; color: #333; }
        .underline { border-bottom: 1px solid #333; min-width: 40px; display: inline-block; text-align: center; }

        .char-block { margin-bottom: 4mm; break-inside: avoid; }
        .row { display: flex; height: 17mm; border-left: 1px solid var(--grid-main); }
        .cell {
            width: 13mm; height: 100%; position: relative;
            border-right: 1px solid var(--grid-main);
            border-bottom: 1px solid var(--grid-main);
            border-top: 1px solid var(--grid-main);
            display: flex; flex-direction: column;
        }
        
        .pinyin { height: 4.5mm; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #666; font-family: Arial; border-bottom: 1px dashed var(--grid-sub); }
        .hanzi { flex: 1; position: relative; }
        
        .grid-lines { position: absolute; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events: none; }
        .char-svg { position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; padding: 7%; box-sizing: border-box; }

        #toast {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 8px 20px;
            border-radius: 20px; font-size: 13px; font-weight: 500;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999;
            backdrop-filter: blur(10px);
        }

        @media print {
            .sidebar, .toolbar, #toast { display: none; }
            .main, .stage { padding: 0; margin: 0; background: white; height: auto; display: block; }
            .sheet { box-shadow: none; margin: 0; page-break-after: always; width: 210mm; min-height: 297mm; }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.2/dist/index.min.js"></script>
</head>
<body>

    <div id="toast">å‡†å¤‡å°±ç»ª</div>

    <aside class="sidebar">
        <div class="brand-area">
            <!-- æ ¸å¿ƒï¼šè¿”å›å¤§å…çš„é“¾æ¥ -->
            <a href="../" class="back-link">
                <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg>
                è¿”å› YoBox å¤§å…
            </a>
            
            <div class="brand-title">âœï¸ å­—å¸–å·¥åŠ <span class="tag">V14.1</span></div>
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" class="search-input" placeholder="æœç´¢ (å¦‚: äºŒå¹´çº§, æ˜“é”™)" oninput="filterCourses(this.value)">
            </div>
        </div>
        
        <div class="course-list" id="menuRoot"></div>

        <div class="settings-panel">
            <div class="control-row" id="batchControlRow" style="display:none;">
                <span class="lbl">ğŸ“š å†…å®¹åˆ†å· (ç‚¹å‡»åˆ‡æ¢)</span>
                <div class="batch-container" id="batchContainer"></div>
            </div>

            <div class="control-row">
                <span class="lbl">ç”Ÿå­—å†…å®¹</span>
                <textarea id="inputStr">å¤©åœ°äººé‡‘æœ¨æ°´ç«åœŸ</textarea>
            </div>
            
            <div class="control-row">
                <span class="lbl">ä¸ªæ€§åŒ–è®¾ç½®</span>
                <div style="display:flex; gap:8px;">
                    <select id="gridType" onchange="render()" style="flex:1">
                        <option value="tian">ç”°å­—æ ¼</option>
                        <option value="mi">ç±³å­—æ ¼</option>
                    </select>
                    <select id="colorTheme" onchange="updateTheme()" style="flex:1">
                        <option value="green">æŠ¤çœ¼ç»¿</option>
                        <option value="red">ä¹¦æ³•çº¢</option>
                    </select>
                </div>
            </div>
            
            <div class="control-row">
                <span class="lbl">æ’ç‰ˆä¸æ¨¡å¼</span>
                <div style="display:flex; gap:8px;">
                    <select id="density" onchange="render()" style="flex:1">
                        <option value="6">æ ‡å‡†(6å­—)</option>
                        <option value="7">ç´§å‡‘(7å­—)</option>
                    </select>
                    <select id="mode" onchange="render()" style="flex:1">
                        <option value="progressive">æ¸éš</option>
                        <option value="trace">æçº¢</option>
                        <option value="empty">ç©ºç™½</option>
                    </select>
                </div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="toolbar">
            <div class="doc-name" id="docTitle">æ¼”ç¤ºç»ƒä¹ </div>
            <button class="btn-print" onclick="window.print()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                ç«‹å³æ‰“å°
            </button>
        </div>
        <div class="stage">
            <div id="previewArea"></div>
        </div>
    </main>

    <script>
        // 1-3å¹´çº§å…¨é›† + æ‰©å±•
        const DB = [
            {
                grade: "ğŸŸ¢ ä¸€å¹´çº§ (å¯è’™)",
                lessons: [
                    { t: "ä¸Šå†Œ (å†™å­—è¡¨)", c: "ä¸€äºŒä¸‰ä¸Šå£ç›®è€³æ‰‹æ—¥ç”°ç¦¾ç«è™«äº‘å±±å…«åäº†å­äººå¤§æœˆå„¿å¤´é‡Œå¯ä¸œè¥¿å¤©å››æ˜¯å¥³å¼€æ°´å»æ¥ä¸å°å°‘ç‰›æœé¸Ÿæ—©ä¹¦åˆ€å°ºæœ¬æœ¨æ—åœŸåŠ›å¿ƒä¸­äº”ç«‹æ­£åœ¨åæˆ‘å¥½é•¿æ¯”å·´æŠŠä¸‹ä¸ªé›¨ä»¬é—®æœ‰åŠä»ä½ æ‰æ˜åŒå­¦è‡ªå·±è¡£ç™½çš„åˆå’Œç«¹ç‰™é©¬ç”¨å‡ åªçŸ³å¤šå‡ºè§å¯¹å¦ˆå…¨å›" },
                    { t: "ä¸‹å†Œ (å†™å­—è¡¨)", c: "æ˜¥é£å†¬é›ªèŠ±é£å…¥å§“ä»€ä¹ˆåŒå›½ç‹æ–¹é’æ¸…æ°”æ™´æƒ…è¯·ç”Ÿå­—å·¦å³çº¢æ—¶åŠ¨ä¸‡åƒå«ä¸»æ±Ÿä½æ²¡ä»¥ä¼šèµ°åŒ—äº¬é—¨å¹¿è¿‡å„æ ·ä¼™ä¼´è¿™å¤ªé˜³æ ¡é‡‘ç§‹å› ä¸ºä¹Ÿä»–åœ°æ²³è¯´å¬å“¥å•å±…æ‹›å‘¼å¿«ä¹ç©å¾ˆå½“éŸ³è®²è¡Œè®¸æ€åºŠå‰å…‰ä½æ•…ä¹¡è‰²å¤–çœ‹çˆ¸æ™šç¬‘å†åˆèŠ‚å¶ç±³çœŸåˆ†è±†é‚£ç€åˆ°é«˜å…´åƒæˆé—´è¿·é€ è¿æ± æ¬¢ç½‘å¤å‡‰ç»†å¤•æè¯­é¦™æ‰“æ‹è·‘è¶³å£°èº«ä½“ä¹‹ç›¸è¿‘ä¹ è¿œç‰ä¹‰é¦–é‡‡æ— æ ‘çˆ±å°–è§’äº®æœºå°æ”¾é±¼æœµç¾ç›´å‘€è¾¹å‘¢å—åŠ æ–‡æ¬¡æ‰¾å¹³åŠè®©åŒ…é’Ÿå…ƒæ´—å…±å·²ç»åè¦è¿ç™¾è¿˜èˆŒç‚¹å—éå¸¸å¾€ç“œè¿›ç©ºåŒ»åˆ«å¹²å¥‡ä¸ƒæ˜Ÿå“æ€•è·Ÿå®¶ç¾Šè±¡éƒ½æ‰æ¡çˆ¬å§æ‚¨è‰æˆ¿" }
                ]
            },
            {
                grade: "ğŸ”µ äºŒå¹´çº§ (è¯†å­—)",
                lessons: [
                    { t: "ä¸Šå†Œ (å†™å­—è¡¨)", c: "ä¸¤å“ªå®½é¡¶çœ¼ç›è‚šçš®å­©è·³å˜æç‰‡å‚æµ·æ´‹ä½œåç»™å¸¦æ³•å¦‚è„šå®ƒå¨ƒå¥¹æ¯›æ›´çŸ¥è¯†å°æ¡¥æµæ°´äººå®¶ç¾¤é˜Ÿæ——é“œå·é¢†å·¾æ¨å£®æ¡æ«æ¾æŸæ£‰æ‰åŒ–æ¡‚æ­Œå†™ä¸›æ·±å…­ç†ŠçŒ«æœ‹å‹å­£å¹è‚¥å†œå¿™å½’çˆ±è¾›è‹¦å¹´ç™¾èŠ±æå´éƒ‘æ¢é™ˆèµµé’±å­™å‘¨ç‹å®˜å¼ å¤è¯—æ‘ç«¥ç¢§å¦†ç»¿ä¸å‰ª" },
                    { t: "ä¸‹å†Œ (å†™å­—è¡¨)", c: "å¤è¯—æ‘ç«¥ç¢§å¦†ç»¿ä¸å‰ªå†²å¯»å§‘å¨˜åæŸ³è¡æ¡ƒæé²œé‚®é€’å‘˜åŸå”å±€å †ç¤¼é‚“æ¤æ ¼å¼•æ³¨æ»¡ä¼‘æ¯ç«™è´´ç”»æ¯çˆ±å¯¹å¶åœ†ç‰‡æ²™æµ·æ»©å†›èˆ°å¸†å·å·¾é“œé¢†é˜Ÿæ——æ¨å£®æ¡æ«æ¾æŸæ£‰æ‰åŒ–æ¡‚æ­Œå†™ä¸›æ·±å…­ç†ŠçŒ«æœ‹å‹å­£å¹è‚¥å†œå¿™å½’çˆ±è¾›è‹¦" }
                ]
            },
            {
                grade: "ğŸŸ  ä¸‰å¹´çº§ (é’¢ç¬”)",
                lessons: [
                    { t: "ä¸Šå†Œ (å†™å­—è¡¨)", c: "æ™¨ç»’çƒæ±‰è‰³æœè£…æ‰®è¯»é™åœç²—å½±åªçŒœæ‰¬è‡‚äº’ç‹‚æ¬¢åŠŸå¤«åŒ–æ‘‡é‡è°·å£è’èˆé›€å ‚æ•¬æˆ’æ‰€æ‰¬è‡‚äº’ç‹‚æ¬¢åŠŸå¤«åŒ–æ‘‡é‡è°·å£è’èˆé›€å ‚æ•¬æˆ’æ‰€ç§å¡¾æ®µè‡³ç»ƒä¹ è‹¦" },
                    { t: "ä¸‹å†Œ (å†™å­—è¡¨)", c: "æƒ å´‡èŠ¦èŠ½çŸ­èé¸³é¸¯ç½—å‡æ—§æ›¾è°™å‡‘æ‹‚é›†èšå½¢æ å¶å°”æ²¾å€¦é—²çº¤ç—•ç“£è“¬èƒ€è£‚å§¿åŠ¿ä»¿ä½›éšè¹ˆæ­¢æŸå®ˆæ ªå¾…å®‹è€•è§¦é¢ˆé‡Šå…¶éª„å‚²è°¦è™šæ‡¦å¼±å°˜æ§ä»£ä»·æ‹‚æ‹­" }
                ]
            },
            {
                grade: "ğŸ“œ å›½å­¦ä¸åŸºç¡€",
                lessons: [
                    { t: "æ•°å­—æ±‰å­— 0-10", c: "é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å" },
                    { t: "ä¸‰å­—ç» (èŠ‚é€‰)", c: "äººä¹‹åˆæ€§æœ¬å–„æ€§ç›¸è¿‘ä¹ ç›¸è¿œè‹Ÿä¸æ•™æ€§ä¹ƒè¿" },
                    { t: "ç™¾å®¶å§“ (å¸¸è§)", c: "èµµé’±å­™æå‘¨å´éƒ‘ç‹å†¯é™ˆè¤šå«è’‹æ²ˆéŸ©æ¨" },
                    { t: "å¿…èƒŒå¤è¯—: å’é¹…", c: "é¹…é¹…é¹…æ›²é¡¹å‘å¤©æ­Œç™½æ¯›æµ®ç»¿æ°´çº¢æŒæ‹¨æ¸…æ³¢" },
                    { t: "å¿…èƒŒå¤è¯—: é™å¤œæ€", c: "åºŠå‰æ˜æœˆå…‰ç–‘æ˜¯åœ°ä¸Šéœœä¸¾å¤´æœ›æ˜æœˆä½å¤´æ€æ•…ä¹¡" }
                ]
            },
            {
                grade: "âœï¸ ä¸“é¡¹çªå‡»",
                lessons: [
                    { t: "ç¬”é¡ºæ˜“é”™å­—", c: "ç«æ–¹ä¸‡ä¹ƒåŠé•¿ç‰‡çš®åŒ—å‡¸å‡¹å¿…" },
                    { t: "å®¹æ˜“å¤šä¸€ç¬”", c: "æ­¦æ­¥æŸ“æ±‚è€ƒçº¸çœŸåº•ä¾¯å…·" },
                    { t: "å®¹æ˜“å°‘ä¸€ç¬”", c: "å£ç´åšçœè€ƒç›´å…·çœŸ" }
                ]
            }
        ];

        // ç¼“å­˜ä¸å¹¶å‘é€»è¾‘
        const charCache = new Map();
        
        window.HanziWriterDefaultOptions = {
            charDataLoader: async (char, onComplete, onErr) => {
                if (charCache.has(char)) { onComplete(charCache.get(char)); return; }
                const sources = [
                    `https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`,
                    `https://npm.elemecdn.com/hanzi-writer-data@2.0/${char}.json`,
                    `https://unpkg.com/hanzi-writer-data@2.0/${char}.json`
                ];
                try {
                    const response = await Promise.any(sources.map(url => fetch(url).then(res => {
                        if (!res.ok) throw new Error('404'); return res.json();
                    })));
                    charCache.set(char, response);
                    onComplete(response);
                } catch (error) { onErr(); }
            }
        };

        const menuRoot = document.getElementById('menuRoot');
        const inputStr = document.getElementById('inputStr');
        const preview = document.getElementById('previewArea');
        const batchContainer = document.getElementById('batchContainer');
        const batchRow = document.getElementById('batchControlRow');
        const BATCH_SIZE = 12; 
        const COLS = 13;
        let timer;
        const { pinyin } = pinyinPro || { pinyin: c=>c };

        function initMenu() {
            menuRoot.innerHTML = '';
            DB.forEach((group, idx) => {
                const header = document.createElement('div');
                header.className = 'group-header';
                if(idx===0) header.classList.add('active');
                header.innerHTML = `<span>${group.grade}</span><svg class="group-arrow" viewBox="0 0 1024 1024" width="10"><path d="M340.992 822.464l369.856-310.272-369.856-310.464z" fill="currentColor"/></svg>`;
                
                const body = document.createElement('div');
                body.className = `group-body ${idx===0?'expanded':''}`;
                
                group.lessons.forEach(l => {
                    const item = document.createElement('div');
                    item.className = 'course-item';
                    item.setAttribute('data-keywords', l.t + l.c);
                    item.innerHTML = `<span>${l.t}</span><span class="count-badge">${l.c.length}å­—</span>`;
                    
                    item.onclick = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.course-item').forEach(x=>x.classList.remove('active'));
                        item.classList.add('active');
                        handleCourseSelection(l.t, l.c);
                    };
                    body.appendChild(item);
                });

                header.onclick = () => {
                    const isOpen = header.classList.contains('active');
                    if(isOpen) {
                        header.classList.remove('active');
                        body.classList.remove('expanded');
                    } else {
                        header.classList.add('active');
                        body.classList.add('expanded');
                    }
                };
                menuRoot.appendChild(header);
                menuRoot.appendChild(body);
            });
            render();
        }

        function handleCourseSelection(title, fullChars) {
            batchContainer.innerHTML = '';
            
            if (fullChars.length <= 15) {
                batchRow.style.display = 'none';
                inputStr.value = fullChars;
                document.getElementById('docTitle').innerText = title + " ç»ƒä¹ ";
                render();
                return;
            }

            batchRow.style.display = 'flex';
            const totalBatches = Math.ceil(fullChars.length / BATCH_SIZE);
            
            for (let i = 0; i < totalBatches; i++) {
                const btn = document.createElement('div');
                btn.className = 'batch-btn';
                const start = i * BATCH_SIZE + 1;
                const end = Math.min((i + 1) * BATCH_SIZE, fullChars.length);
                btn.innerText = `ç¬¬${i+1}å· (${start}-${end})`;
                
                btn.onclick = () => {
                    document.querySelectorAll('.batch-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const slice = fullChars.substring(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
                    inputStr.value = slice;
                    document.getElementById('docTitle').innerText = `${title} (ç¬¬${i+1}å·)`;
                    render();
                };
                batchContainer.appendChild(btn);
            }
            batchContainer.firstChild.click();
        }

        function filterCourses(val) {
            val = val.trim().toLowerCase();
            const groups = document.querySelectorAll('.group-body');
            groups.forEach((group) => {
                let hasMatch = false;
                const items = group.querySelectorAll('.course-item');
                items.forEach(item => {
                    const key = item.getAttribute('data-keywords').toLowerCase();
                    if(key.includes(val)) { item.classList.remove('hidden'); hasMatch = true; } 
                    else { item.classList.add('hidden'); }
                });
                if(hasMatch || val === '') {
                    group.previousSibling.style.display = 'flex';
                    if(val !== '') { group.classList.add('expanded'); group.previousSibling.classList.add('active'); }
                } else {
                    group.previousSibling.style.display = 'none';
                    group.classList.remove('expanded');
                }
            });
        }

        async function render() {
            showToast('æ­£åœ¨ç”Ÿæˆ...');
            const str = inputStr.value.replace(/[^\u4e00-\u9fa5]/g,'');
            const chars = Array.from(new Set(str.split('')));
            const mode = document.getElementById('mode').value;
            const type = document.getElementById('gridType').value;
            const density = parseInt(document.getElementById('density').value);

            preview.innerHTML = '';
            if(!chars.length) { preview.innerHTML='<div style="text-align:center;padding:50px;color:#999">è¯·é€‰æ‹©è¯¾ç¨‹æˆ–è¾“å…¥æ±‰å­—</div>'; return; }

            const pages = Math.ceil(chars.length / density);
            for(let p=0; p<pages; p++) {
                const sheet = document.createElement('div');
                sheet.className = 'sheet';
                sheet.innerHTML = `
                    <div class="sheet-header">
                        <div>${document.getElementById('docTitle').innerText}</div>
                        <div>æ—¥æœŸï¼š<span class="underline"></span> è¯„åˆ†ï¼š<span class="underline"></span></div>
                    </div>
                    <div class="sheet-content"></div>
                `;
                const content = sheet.querySelector('.sheet-content');
                const slice = chars.slice(p*density, (p+1)*density);

                await Promise.all(slice.map(async (char) => {
                    const placeholder = document.createElement('div');
                    content.appendChild(placeholder);
                    try {
                        const data = await HanziWriter.loadCharacterData(char);
                        const block = createBlock(char, data, mode, type);
                        content.replaceChild(block, placeholder);
                    } catch(e) {
                        const err = document.createElement('div');
                        err.innerHTML = `<span style="color:red">[${char}]</span> åŠ è½½å¤±è´¥`;
                        err.style.padding = '10px';
                        content.replaceChild(err, placeholder);
                    }
                }));
                preview.appendChild(sheet);
            }
            showToast('å®Œæˆ', 800);
        }

        function createBlock(char, data, mode, type) {
            const blk = document.createElement('div'); blk.className = 'char-block';
            const sts = data.strokes;
            const py = pinyin(char);

            const r1 = document.createElement('div'); r1.className = 'row';
            for(let i=0; i<COLS; i++) {
                let m='empty', s=-1;
                if(i===0) m='black'; else if(i<=sts.length){m='step';s=i-1} else m='trace';
                r1.appendChild(createCell(sts, py, m, s, type, i===0));
            }
            blk.appendChild(r1);

            const r2 = document.createElement('div'); r2.className = 'row'; r2.style.borderTop='none';
            for(let i=0; i<COLS; i++) {
                let m='empty', op=1;
                if(i===0) m='black';
                else {
                    if(mode==='trace') m='trace';
                    else if(mode==='empty') m='empty';
                    else if(mode==='progressive') { if(i<4){m='trace';op=0.8}else if(i<8){m='trace';op=0.3}else m='empty'; }
                }
                const c = createCell(sts, '', m, -1, type, false);
                if(m==='trace' && op!==1) c.querySelector('path').style.opacity = op;
                r2.appendChild(c);
            }
            blk.appendChild(r2);
            return blk;
        }

        function createCell(sts, pyStr, mode, step, type, showCnt) {
            const cell = document.createElement('div'); cell.className = 'cell';
            const pd = document.createElement('div'); pd.className = 'pinyin'; pd.innerText = pyStr||'';
            if(showCnt) {
                const badge = document.createElement('span');
                badge.style.cssText = "position:absolute;right:2px;top:1px;font-size:8px;color:#999";
                badge.innerText = sts.length;
                pd.appendChild(badge);
            }
            cell.appendChild(pd);

            const hd = document.createElement('div'); hd.className = 'hanzi';
            let lines = `<line x1="0" y1="50%" x2="100%" y2="50%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/><line x1="50%" y1="0" x2="50%" y2="100%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/>`;
            if(type==='mi') lines += `<line x1="0" y1="0" x2="100%" y2="100%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/><line x1="100%" y1="0" x2="0" y2="100%" stroke="var(--grid-sub)" stroke-dasharray="4,4"/>`;
            hd.innerHTML = `<svg class="grid-lines" width="100%" height="100%">${lines}</svg>`;

            if(sts && mode!=='empty') {
                let pathStr = '';
                sts.forEach((p, i) => {
                    let color = 'var(--char-color)';
                    if(mode==='trace') color='#d1d1d6';
                    else if(mode==='step') {
                        if(i<step) color='#d1d1d6';
                        else if(i===step) color='#ff3b30';
                        else return;
                    }
                    pathStr += `<path d="${p}" fill="${color}"/>`;
                });
                hd.insertAdjacentHTML('beforeend', `<svg class="char-svg" viewBox="0 0 1024 1024"><g transform="scale(1, -1) translate(0, -900)">${pathStr}</g></svg>`);
            }
            cell.appendChild(hd);
            return cell;
        }

        function updateTheme() {
            const t = document.getElementById('colorTheme').value;
            const r = document.documentElement.style;
            if(t==='green') { r.setProperty('--grid-main', '#2c8a4c'); r.setProperty('--grid-sub', '#a1dcb6'); }
            else { r.setProperty('--grid-main', '#d93a3a'); r.setProperty('--grid-sub', '#ffb3b0'); }
            render();
        }

        function showToast(m, t) {
            const el = document.getElementById('toast');
            el.innerText = m; el.style.opacity = 1;
            if(t) setTimeout(()=>el.style.opacity=0, t);
        }

        inputStr.addEventListener('input', ()=> {
            clearTimeout(timer);
            batchRow.style.display = 'none';
            document.getElementById('docTitle').innerText = "è‡ªå®šä¹‰ç»ƒä¹ ";
            timer = setTimeout(render, 500);
        });

        window.onload = initMenu;
    </script>
</body>
</html>
